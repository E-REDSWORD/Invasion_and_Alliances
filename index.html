<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>REDSWORD Games - ููุญุฉ ุงููุดุฑู | ุงูุบุฒู ูุงูุชุญุงููุงุช</title>
  <style>
    :root{
      --bg:#f7f7f9;
      --card:#ffffff;
      --text:#1a1a1b;
      --muted:#68686b;
      --accent:#c00000; /* REDSWORD */
      --accent-dark:#8f0000;
      --border:#e5e6ea;
      --ok:#0a7d33;
      --warn:#cc7a00;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic","Noto Sans Arabic",Tahoma,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      background:var(--card); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    .brand{
      display:flex; align-items:center; gap:.75rem; padding:.9rem 1rem;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:8px; background:var(--accent);
      display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800;
      box-shadow:0 2px 8px rgba(192,0,0,.25);
    }
    .brand .titles{display:flex; flex-direction:column; line-height:1.2}
    .brand .titles .site{font-weight:800}
    .brand .titles .game{font-size:.9rem; color:var(--muted)}
    main{padding:1rem; max-width:900px; margin:0 auto;}

    .nav{
      display:grid; grid-template-columns:1fr; gap:.5rem; margin: .5rem 0 1rem;
    }
    .nav button{
      width:100%; padding:.8rem 1rem; border:1px solid var(--border);
      background:var(--card); border-radius:10px; font-weight:700; color:var(--text); cursor:pointer;
    }
    .nav button.active{border-color:var(--accent); box-shadow:0 0 0 3px rgba(192,0,0,.12)}

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1rem; margin-bottom:1rem;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    h2{margin:.2rem 0 1rem; font-size:1.1rem}
    .row{display:grid; grid-template-columns:1fr; gap:.75rem}
    @media (min-width:640px){ .row-2{grid-template-columns:1fr 1fr} }
    label{font-size:.9rem; color:var(--muted); display:block; margin-bottom:.25rem}
    input[type="text"], select{
      width:100%; padding:.7rem .8rem; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
      appearance:none;
    }
    .btn{
      display:inline-flex; align-items:center; gap:.5rem; padding:.75rem 1rem; border:none; border-radius:10px; font-weight:800; cursor:pointer;
    }
    .btn.primary{background:var(--accent); color:#fff}
    .btn.primary:active{background:var(--accent-dark)}
    .btn.ghost{background:var(--card); border:1px solid var(--border)}
    .btn.success{background:var(--ok); color:#fff}
    .btn.warn{background:var(--warn); color:#fff}
    .stack{display:flex; flex-wrap:wrap; gap:.6rem}
    .list{display:grid; grid-template-columns:1fr; gap:.5rem}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      padding:.6rem .8rem; border:1px solid var(--border); border-radius:10px; background:#fff;
    }
    .item .name{font-weight:700}
    .small{font-size:.85rem; color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .5rem; border-radius:8px; border:1px solid var(--border);
      background:#fafafa; font-size:.85rem;
    }
    .grid{display:grid; grid-template-columns:1fr; gap:.75rem}
    @media (min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}}
    .table{width:100%; border-collapse:collapse; font-size:.95rem}
    .table th, .table td{border:1px solid var(--border); padding:.6rem .5rem; text-align:center}
    .table th{background:#fafafa}
    .muted{color:var(--muted)}
    textarea{
      width:100%; min-height:120px; padding:.8rem; border:1px solid var(--border); border-radius:10px; resize:vertical;
      background:#fff; color:var(--text); font-family:inherit;
    }
    .footer{padding:1rem; text-align:center; color:var(--muted); font-size:.85rem}
    .actions-cell{display:flex; gap:.4rem; justify-content:center; flex-wrap:wrap}
    .hint{font-size:.85rem; color:var(--muted)}
    .dashboard-grid{display:grid; grid-template-columns:1fr; gap:.75rem; margin-top:1rem}
    @media (min-width:640px){ .dashboard-grid{grid-template-columns:1fr 1fr} }
    .dashboard-card{background:var(--card); border-radius:12px; padding:1rem; border:1px solid var(--border)}
    .dashboard-card h3{margin:0 0 .5rem; font-size:1rem}
    .dashboard-card .value{font-size:1.5rem; font-weight:800; color:var(--accent)}
    .quick-actions{display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-top:1rem}
    .quick-action-btn{background:var(--card); border:1px solid var(--border); border-radius:8px; padding:.7rem; text-align:center; cursor:pointer}
    .quick-action-btn:hover{background:#f0f0f0}
    .quick-action-btn .icon{font-size:1.2rem; margin-bottom:.3rem}
    .quick-action-btn .label{font-size:.8rem; font-weight:600}
    .fast-entry{display:grid; grid-template-columns:2fr 1fr 1fr; gap:.5rem; align-items:end; margin-bottom:.5rem}
    .fast-entry .player-name{font-weight:600; padding:.5rem 0}
    .fast-entry select{padding:.5rem .4rem; font-size:.85rem}
    .fast-entry .actions{display:flex; gap:.3rem}
    .fast-entry .actions button{padding:.4rem .6rem; font-size:.8rem}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">RS</div>
    <div class="titles">
      <div class="site">REDSWORD Games</div>
      <div class="game">ููุญุฉ ุงููุดุฑู โ ูุนุจุฉ ุงูุบุฒู ูุงูุชุญุงููุงุช</div>
    </div>
  </div>
</header>

<main>
  <div class="nav">
    <button class="active" data-tab="dashboard">ููุญุฉ ุงูุชุญูู</button>
    <button data-tab="players">ุฅุถุงูุฉ ุงููุงุนุจูู</button>
    <button data-tab="round">ุฅุฏุงุฑุฉ ุงูุฌููุฉ</button>
    <button data-tab="points">ุงูููุงุท ูุงูุจุทุงูุงุช</button>
    <button data-tab="help">ุชุนูููุงุช ููุณุนุฉ</button>
  </div>

  <!-- ููุญุฉ ุงูุชุญูู -->
  <section class="card" id="tab-dashboard">
    <h2>ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ</h2>
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h3>ุนุฏุฏ ุงููุงุนุจูู</h3>
        <div class="value" id="dashboard-player-count">0</div>
      </div>
      <div class="dashboard-card">
        <h3>ุงูุฌููุฉ ุงูุญุงููุฉ</h3>
        <div class="value" id="dashboard-round">1</div>
      </div>
      <div class="dashboard-card">
        <h3>ุฃุนูู ููุงุท</h3>
        <div class="value" id="dashboard-top-score">0</div>
        <div class="small" id="dashboard-top-player">ูุง ููุฌุฏ</div>
      </div>
      <div class="dashboard-card">
        <h3>ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ</h3>
        <div class="value" id="dashboard-cards-used">0</div>
      </div>
    </div>
    
    <div class="quick-actions">
      <div class="quick-action-btn" data-action="add-players">
        <div class="icon">๐ค</div>
        <div class="label">ุฅุถุงูุฉ ูุงุนุจูู</div>
      </div>
      <div class="quick-action-btn" data-action="start-round">
        <div class="icon">๐</div>
        <div class="label">ุจุฏุก ุฌููุฉ</div>
      </div>
      <div class="quick-action-btn" data-action="manage-round">
        <div class="icon">โ๏ธ</div>
        <div class="label">ุฅุฏุงุฑุฉ ุงูุฌููุฉ</div>
      </div>
      <div class="quick-action-btn" data-action="view-points">
        <div class="icon">๐</div>
        <div class="label">ุนุฑุถ ุงูููุงุท</div>
      </div>
    </div>
    
    <div class="card" style="margin-top:1rem">
      <h2>ุงูุฅุฌุฑุงุกุงุช ุงูุณุฑูุนุฉ</h2>
      <div class="stack">
        <button class="btn primary" id="quick-start-game">ุจุฏุก ุงููุนุจุฉ</button>
        <button class="btn ghost" id="quick-next-round">ุฌููุฉ ุฌุฏูุฏุฉ</button>
        <button class="btn success" id="quick-calculate">ุญุณุงุจ ุงูููุงุท</button>
      </div>
    </div>
  </section>

  <!-- ุฅุถุงูุฉ ุงููุงุนุจูู -->
  <section class="card" id="tab-players" style="display:none">
    <h2>ุฅุถุงูุฉ ุงููุงุนุจูู</h2>
    <div class="row row-2">
      <div>
        <label>ุงุณู ุงูุฏููุฉ/ุงููุจููุฉ</label>
        <input type="text" id="playerName" placeholder="ูุซุงู: ุฅูุจุฑุงุทูุฑูุฉ ุงูุตุญุฑุงุก" />
        <div class="hint">ุฅุฐุง ุชุฑูุช ุงูุงุณู ูุงุฑุบูุง ุณููุถุงู ุจุงุณู ุชููุงุฆู: "ูุงุนุจ 1"ุ "ูุงุนุจ 2"...</div>
      </div>
      <div class="stack" style="align-items:flex-end">
        <button class="btn primary" id="addPlayerBtn">ุฅุถุงูุฉ ูุงุนุจ</button>
        <button class="btn ghost" id="clearPlayersBtn">ูุณุญ ุงููุงุนุจูู</button>
      </div>
    </div>
    <div style="margin-top:.75rem">
      <div class="small">ุงููุงุนุจูู ุงููุถุงููู:</div>
      <div id="playersList" class="list"></div>
    </div>
    <div style="margin-top:1rem" class="stack">
      <button class="btn success" id="startGameBtn">ุจุฏุก ุงูุฌููุฉ ุงูุฃููู</button>
      <span class="small muted" id="playersCountInfo"></span>
    </div>
  </section>

  <!-- ุฅุฏุงุฑุฉ ุงูุฌููุฉ -->
  <section class="card" id="tab-round" style="display:none">
    <h2>ุฅุฏุงุฑุฉ ุงูุฌููุฉ</h2>
    <div class="stack" style="margin-bottom:.75rem">
      <div class="tag">ุงูุฌููุฉ ุงูุญุงููุฉ: <span id="roundNumber">1</span></div>
      <button class="btn ghost" id="newRoundBtn">ุจุฏุก ุฌููุฉ ุฌุฏูุฏุฉ</button>
    </div>

    <div class="card">
      <h2>ุฅุฏุฎุงู ุณุฑูุน ูููุฑุงุฑุงุช</h2>
      <div class="hint">ุฃุฏุฎู ูุฑุงุฑุงุช ุฌููุน ุงููุงุนุจูู ุจุณุฑุนุฉ ุซู ุงููุฑ "ุฅุนูุงู ุงููุชุงุฆุฌ" ูุญุณุงุจ ูู ุดูุก ุชููุงุฆููุง</div>
      <div id="fastEntryContainer"></div>
      <div class="stack" style="margin-top:.5rem">
        <button class="btn primary" id="finalizeBtn">ุฅุนูุงู ุงููุชุงุฆุฌ ูุญุณุงุจ ุงูููุงุท</button>
        <button class="btn ghost" id="resetDecisionsBtn">ูุณุญ ุงููุฑุงุฑุงุช</button>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>ูุชุงุฆุฌ ุงูุฌููุฉ</h2>
      <textarea id="resultsText" readonly placeholder="ุณูุธูุฑ ููุง ูุต ุงููุชุงุฆุฌ ุงูุฌุงูุฒ ูููุฑุงุกุฉ..."></textarea>
      <div class="stack" style="margin-top:.6rem">
        <button class="btn primary" id="copyResultsBtn">ูุณุฎ ุงููุชุงุฆุฌ ููุต</button>
      </div>
    </div>
  </section>

  <!-- ุงูููุงุท ูุงูุจุทุงูุงุช -->
  <section class="card" id="tab-points" style="display:none">
    <h2>ุงูููุงุท ูุงูุจุทุงูุงุช ุงูุฎุงุตุฉ</h2>
    <div style="overflow:auto">
      <table class="table" id="pointsTable">
        <thead>
          <tr>
            <th>ุงููุงุนุจ</th>
            <th>ุงูููุงุท</th>
            <th>ูุฌูุงุช ูุงุฌุญุฉ ูุชุชุงููุฉ</th>
            <th>ุชุญุงููุงุช ููุงุก</th>
            <th>ุตููุงุช ุชุฌุงุฑุฉ</th>
            <th>ุจุทุงูุงุช</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ุชุนูููุงุช ููุณุนุฉ -->
  <section class="card" id="tab-help" style="display:none">
    <h2>ุชุนูููุงุช ุงููุนุจุฉ โ ููุงุนุจูู ูุงููุดุฑู</h2>

    <div class="card">
      <h2>ุชุนูููุงุช ุงููุงุนุจูู</h2>
      <ul class="list">
        <li class="item"><span class="name">ุงูุฏูุฑ</span><span class="small">ุชูุซู ุฏููุฉ/ูุจููุฉ. ูููุชู ูู ุงูุญููุฉ ูุงูุชุญุงูู ูุงูุฎุฏุงุน.</span></li>
        <li class="item"><span class="name">ุงููุฑุงุฑุงุช ุงูููููุฉ</span><span class="small">ูุฌููุ ุชุญุงููุ ุชุฌุงุฑุฉุ ุฎูุงูุฉ (ุฅู ุฃุนููุช ุชุญุงูููุง ุนููููุง)ุ ุฃู ูุง ุดูุก.</span></li>
        <li class="item"><span class="name">ุงูููุงุด ุงูุนููู</span><span class="small">ุงุจูู ุณุฑุฏู: ุชูุงูุถุ ูุฏูุฏุ ุดููุด. ูุง ุชูููู ุนูููุง ูุง ูุณุงูู ุงูุชูููุฐ ุงูุณุฑู.</span></li>
        <li class="item"><span class="name">ุงูุฅุฑุณุงู ุงูุณุฑู</span><span class="small">ุฃุฑุณู ูุฑุงุฑู ูููุดุฑู ูู ุงูุฎุงุต ุจุฏูุฉ (ุงููุนู + ุงููุฏู/ุงูุดุฑูู).</span></li>
        <li class="item"><span class="name">ุงูููุงุท</span><span class="small">ูุฌูู ูุงุฌุญ +2 (ุฃู +4 ูุน ุจุทุงูุฉ)ุ ุชุญุงูู ูุชุจุงุฏู +1 ููู ุทุฑูุ ุชุฌุงุฑุฉ ูุชุจุงุฏูุฉ +1 (ุฃู +2 ูุน ุจุทุงูุฉ).</span></li>
        <li class="item"><span class="name">ุงูุจุทุงูุงุช ุจุงูุฅูุฌุงุฒ</span><span class="small">ูุฌูููู ูุชุชุงููู โ ูุฌูู ูุถุงุนูุ ุชุญุงูููู ููุงุก โ ุญุตุงูุฉุ ุซูุงุซ ุชุฌุงุฑุงุช โ ุชุงุฌุฑุ ุฎูุงูุฉ ูุงุฌุญุฉ โ ูุดู.</span></li>
        <li class="item"><span class="name">ุงุณุชุฑุงุชูุฌูุงุช</span><span class="small">ุงุจูู ุณูุนุฉุ ุดููุด ุงูููุงูุงุ ุงูุฑุฃ ุฎุตูููุ ููุงุฒู ุงููุฎุงุทุฑ.</span></li>
      </ul>
    </div>

    <div class="card">
      <h2>ุชุนูููุงุช ุงููุดุฑู</h2>
      <ul class="list">
        <li class="item"><span class="name">ุฅุฏุงุฑุฉ ุงูุฌููุฉ</span><span class="small">ุงูุชุญ ููุงุดูุง ุนููููุง ูุตูุฑูุงุ ุซู ุฃุฏุฎู ุงููุฑุงุฑุงุช ุงูุณุฑูุฉ ูู ุงูุตูุญุฉ. ุฒุฑ ุงูุญุณุงุจ ูุญูุธ ููุญุณุจ ุฏูุนุฉ ูุงุญุฏุฉ.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงูุชุญุงูู</span><span class="small">ูุง ููุทุฉ ุฅูุง ุฅุฐุง ูุงู ุงูุชุญุงูู ูุชุจุงุฏููุง ุณุฑูุง. ูููุน ุงููุฌูุงุช ุนูู ุงูุทุฑููู ูู ุชูู ุงูุฌููุฉ.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงูุชุฌุงุฑุฉ</span><span class="small">ููุทุฉ ููู ุทุฑู ุนูุฏ ุงูุชุจุงุฏู ุงููุชุจุงุฏู. ูุน ุจุทุงูุฉ ุงูุชุงุฌุฑ ุชุตุจุญ ููุทุชูู.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงููุฌูู</span><span class="small">ููุดู ุงููุฌูู ุฅู ูุงู ุงููุฏู ูุชุญุงูููุง ุฃู ุงุณุชุฎุฏู ุญุตุงูุฉ. ููุฌุญ ุฅู ูู ููู ูุญูููุง.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงูุฎูุงูุฉ</span><span class="small">ูุง ุชูุนุชุจุฑ ุฎูุงูุฉ ุฅูุง ุฅุฐุง ุฃุนูู ุงููุงุนุจ ุงูุชุญุงูู ุนูููุง ุซู ุฃุฑุณู "ุฎูุงูุฉ" ูุน ูุฌูู.</span></li>
        <li class="item"><span class="name">ุงูุจุทุงูุงุช ุงูุชููุงุฆูุฉ</span><span class="small">ุฌููุน ุงูุจุทุงูุงุช ุชููุนูู ุชููุงุฆููุง ูู ุงูุฌููุฉ ุงูุชุงููุฉ ููุญุตูู ุนูููุง ูุชูุณุชููู ุจุนุฏ ุงุณุชุฎุฏุงููุง.</span></li>
        <li class="item"><span class="name">ุงูุฅูุตุงุก ุงูุชููุงุฆู</span><span class="small">ูุชู ุงูุฅูุตุงุก ุชููุงุฆููุง ูู ุญุงูุชูู: 1) ุชุนุฑุถ ูุงุนุจ ููุฌูููู ูุงุฌุญูู ูู ููุณ ุงูุฌููุฉ 2) ุงูุฃูู ููุงุทูุง ูู ูู ุฌููุชูู ูุชุชุงููุชูู (ุจุฏุกูุง ูู ุงูุฌููุฉ ุงูุซุงููุฉ).</span></li>
      </ul>
    </div>

    <div class="card">
      <h2>ุญุงูุงุช ุฎุงุตุฉ</h2>
      <ul class="list">
        <li class="item"><span class="name">ูุฌููุงู ูุชูุงุจูุงู</span><span class="small">ูููููู ูู ูุฌูู ูุณุชูููุง ููู ุญูุงูุฉ ุงููุฏู.</span></li>
        <li class="item"><span class="name">ุฎูุงูุฉ ุจุฏูู ุฅุนูุงู</span><span class="small">ููุนุงูู ููุฌูู ุนุงุฏู.</span></li>
        <li class="item"><span class="name">ุงูุชุนุงุฏู ูู ุงูุฅูุตุงุก</span><span class="small">ุฅุฐุง ุชุนุงุฏู ุงููุงุนุ ูููุตู ุฌููุน ุงููุชุนุงุฏููู ูู ุญุงูุฉ ุงูุฃูู ููุงุทูุง ูุฌููุชูู.</span></li>
        <li class="item"><span class="name">ุชูุนูู ุงูุจุทุงูุงุช</span><span class="small">ุฌููุน ุงูุจุทุงูุงุช ุชููุนูู ุชููุงุฆููุง ูู ุงูุฌููุฉ ุงูุชุงููุฉ ููุญุตูู ุนูููุง.</span></li>
      </ul>
    </div>
  </section>

  <div class="footer">ุชุงุจุน ููููุน ุฃูุนุงุจ REDSWORD โ ูุตูู ูููุงุชูุ ุณูุณ ููุงูู ูููุดุฑู ููุท.</div>
</main>

<script>
(() => {
  // ุญุงูุฉ ุงููุนุจุฉ
  const state = {
    players: [], // {id,name,points,streakAttack,loyalAlliances,tradeCount,cards:[],history:{failedBetrayRounds:[]}, lastRoundPoints: null}
    round: 1,
    decisions: new Map(), // playerId -> {action,targetId,announcedAllianceWithId,usesCard:null|cardKey}
    autoCounter: 1,
    lastRoundPointsSnapshot: new Map(), // playerId -> points at end of round
    attacksThisRound: [], // {attackerId,targetId,success}
    // ุจุทุงูุงุช
    cardsCatalog: {
      shield: { key:'shield', name:'ุจุทุงูุฉ ุงูุญุตุงูุฉ', desc:'ุชููุน ูุฌูููุง ูุงุญุฏูุง ุถุฏู ูู ุงูุฌููุฉ ุงูุชุงููุฉ' },
      doubleAttack: { key:'doubleAttack', name:'ุจุทุงูุฉ ุงููุฌูู ุงููุถุงุนู', desc:'ุชุถุงุนู ููุงุท ุงููุฌูู ุงููุงุฌุญ ูู 2 ุฅูู 4 ููุงุท' },
      doubleTrade: { key:'doubleTrade', name:'ุจุทุงูุฉ ุงูุชุงุฌุฑ', desc:'ุชุถุงุนู ููุงุท ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ ูู 1 ุฅูู 2 ููุงุท' },
      reveal: { key:'reveal', name:'ุจุทุงูุฉ ุงููุดู', desc:'ุชุชูุญ ูููุดุฑู ูุดู ูุฑุงุฑ ูุงุนุจ ูุงุญุฏ ูุจู ุงูุฅุนูุงู' }
    },
    cardsToActivate: new Map() // playerId -> [cardKeys] ุงูุจุทุงูุงุช ุงูุชู ุณุชููุนูู ูู ุงูุฌููุฉ ุงูุชุงููุฉ
  };

  // ุนูุงุตุฑ DOM
  const tabs = document.querySelectorAll('.nav button');
  const sections = {
    dashboard: document.getElementById('tab-dashboard'),
    players: document.getElementById('tab-players'),
    round: document.getElementById('tab-round'),
    points: document.getElementById('tab-points'),
    help: document.getElementById('tab-help')
  };
  const playerNameInput = document.getElementById('playerName');
  const addPlayerBtn = document.getElementById('addPlayerBtn');
  const clearPlayersBtn = document.getElementById('clearPlayersBtn');
  const playersList = document.getElementById('playersList');
  const playersCountInfo = document.getElementById('playersCountInfo');
  const startGameBtn = document.getElementById('startGameBtn');

  const fastEntryContainer = document.getElementById('fastEntryContainer');
  const finalizeBtn = document.getElementById('finalizeBtn');
  const resetDecisionsBtn = document.getElementById('resetDecisionsBtn');
  const resultsText = document.getElementById('resultsText');
  const copyResultsBtn = document.getElementById('copyResultsBtn');
  const roundNumberEl = document.getElementById('roundNumber');
  const newRoundBtn = document.getElementById('newRoundBtn');

  const pointsTableBody = document.querySelector('#pointsTable tbody');

  // ููุญุฉ ุงูุชุญูู
  const dashboardPlayerCount = document.getElementById('dashboard-player-count');
  const dashboardRound = document.getElementById('dashboard-round');
  const dashboardTopScore = document.getElementById('dashboard-top-score');
  const dashboardTopPlayer = document.getElementById('dashboard-top-player');
  const dashboardCardsUsed = document.getElementById('dashboard-cards-used');
  const quickStartGameBtn = document.getElementById('quick-start-game');
  const quickNextRoundBtn = document.getElementById('quick-next-round');
  const quickCalculateBtn = document.getElementById('quick-calculate');

  // ุชุจุฏูู ุงูุชุจููุจุงุช
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      // ุญูุธ ุงููุฑุงุฑุงุช ูุจู ุงูุฎุฑูุฌ ูู ุตูุญุฉ ุงูุฌููุฉ
      if (document.getElementById('tab-round').style.display !== 'none') {
        saveDecisionsFromForm();
      }
      
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      Object.keys(sections).forEach(k=>{
        sections[k].style.display = (k===tab?'block':'none');
      });
      if(tab==='points') renderPointsTable();
      if(tab==='round') { renderFastEntryForm(); roundNumberEl.textContent = state.round; }
      if(tab==='dashboard') updateDashboard();
    });
  });

  // ุฅุถุงูุฉ ูุงุนุจ (ุงุณู ุชููุงุฆู ุฅู ูุงู ูุงุฑุบ)
  addPlayerBtn.addEventListener('click', ()=>{
    let name = playerNameInput.value.trim();
    if(!name){
      name = "ูุงุนุจ " + (state.autoCounter++);
    }
    const id = cryptoRandomId();
    state.players.push({
      id,name,points:0,streakAttack:0,loyalAlliances:0,tradeCount:0,cards:[],
      history:{failedBetrayRounds:[]}
    });
    playerNameInput.value='';
    renderPlayersList();
    updateDashboard();
  });

  // ุชูููุถ ุชุนุฏูู/ุฅุฒุงูุฉ ุงููุงุนุจูู
  playersList.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const index = parseInt(btn.dataset.index,10);
    const action = btn.dataset.action;
    if(action==='edit'){
      const newName = prompt("ุฃุฏุฎู ุงูุงุณู ุงูุฌุฏูุฏ:", state.players[index].name);
      if(newName && newName.trim()){
        state.players[index].name = newName.trim();
        renderPlayersList();
        renderFastEntryForm();
        renderPointsTable();
        updateDashboard();
      }
    } else if(action==='remove'){
      if(confirm("ูู ุชุฑูุฏ ุฅุฒุงูุฉ ูุฐุง ุงููุงุนุจุ")){
        const removed = state.players.splice(index,1)[0];
        state.decisions.delete(removed.id);
        // ุชูุธูู ุงููุฑุงุฑุงุช ุงููุฑุฌุนูุฉ
        state.decisions.forEach((d,pid)=>{
          if(d.targetId===removed.id) d.targetId = null;
          if(d.announcedAllianceWithId===removed.id) d.announcedAllianceWithId = null;
        });
        renderPlayersList();
        renderFastEntryForm();
        renderPointsTable();
        updateDashboard();
      }
    }
  });

  // ูุณุญ ุฌููุน ุงููุงุนุจูู
  clearPlayersBtn.addEventListener('click', ()=>{
    if(!confirm('ูู ุชุฑูุฏ ูุณุญ ุฌููุน ุงููุงุนุจููุ')) return;
    state.players = [];
    state.decisions.clear();
    state.round = 1;
    state.lastRoundPointsSnapshot.clear();
    state.attacksThisRound = [];
    state.cardsToActivate.clear();
    resultsText.value='';
    roundNumberEl.textContent = state.round;
    renderPlayersList();
    fastEntryContainer.innerHTML='';
    pointsTableBody.innerHTML='';
    updateDashboard();
  });

  // ุจุฏุก ุงูุฌููุฉ ุงูุฃููู
  startGameBtn.addEventListener('click', ()=>{
    if(state.players.length < 2) return alert('ุฃุถู ูุงุนุจูู ููุงูุฉ (ุนูู ุงูุฃูู 2)');
    switchTab('round');
  });

  // ุฌููุฉ ุฌุฏูุฏุฉ
  newRoundBtn.addEventListener('click', ()=>{
    state.round += 1;
    state.decisions.clear();
    state.attacksThisRound = [];
    resultsText.value='';
    roundNumberEl.textContent = state.round;
    
    // ุชูุนูู ุงูุจุทุงูุงุช ููุฌููุฉ ุงูุฌุฏูุฏุฉ
    activateCardsForNewRound();
    
    renderFastEntryForm();
    updateDashboard();
  });

  // ูุณุฎ ุงููุชุงุฆุฌ
  copyResultsBtn.addEventListener('click', ()=>{
    resultsText.select();
    document.execCommand('copy');
    alert('ุชู ูุณุฎ ุงููุชุงุฆุฌ ููุต ุฌุงูุฒ.');
  });

  // ูุณุญ ุงููุฑุงุฑุงุช
  resetDecisionsBtn.addEventListener('click', ()=>{
    if(!confirm('ูุณุญ ุฌููุน ุงููุฑุงุฑุงุช ููุฐู ุงูุฌููุฉุ')) return;
    state.decisions.clear();
    renderFastEntryForm();
    resultsText.value='';
  });

  // ุฅุนูุงู ุงููุชุงุฆุฌ: ูุญูุธ ุฌููุน ุงููุฑุงุฑุงุช ุชููุงุฆููุง ุซู ูุญุณุจ
  finalizeBtn.addEventListener('click', ()=>{
    if(state.players.length < 2) return alert('ุฃุถู ูุงุนุจูู ููุงูุฉ (ุนูู ุงูุฃูู 2)');
    
    // ุญูุธ ุชููุงุฆู ูููุฑุงุฑุงุช ูู ุงููุงุฌูุฉ ุงูุณุฑูุนุฉ
    saveDecisionsFromForm();

    // ุญุณุงุจ ุงููุชุงุฆุฌ
    const calc = computeResults();
    resultsText.value = calc.text;
    applyPoints(calc);
    awardCards(calc);
    
    // ุงูุฅูุตุงุก ุงูุชููุงุฆู
    const eliminationResults = performAutoElimination();
    if (eliminationResults) {
      resultsText.value += "\n\n" + eliminationResults;
    }
    
    renderPointsTable();
    // ููุทุฉ ููุงุท ูุฐู ุงูุฌููุฉ ูุฃุบุฑุงุถ "ุงูุฃูู ููุงุทูุง ูุฌููุชูู"
    state.lastRoundPointsSnapshot = new Map(state.players.map(p=>[p.id,p.points]));
    alert('ุชู ุญุณุงุจ ุงููุชุงุฆุฌ ูุชุญุฏูุซ ุงูููุงุท ูุงูุฅูุตุงุก ุงูุชููุงุฆู.');
    updateDashboard();
  });

  // ุงูุฅุฌุฑุงุกุงุช ุงูุณุฑูุนุฉ
  quickStartGameBtn.addEventListener('click', ()=>{
    if(state.players.length < 2) return alert('ุฃุถู ูุงุนุจูู ููุงูุฉ (ุนูู ุงูุฃูู 2)');
    switchTab('round');
  });

  quickNextRoundBtn.addEventListener('click', ()=>{
    state.round += 1;
    state.decisions.clear();
    state.attacksThisRound = [];
    resultsText.value='';
    roundNumberEl.textContent = state.round;
    
    // ุชูุนูู ุงูุจุทุงูุงุช ููุฌููุฉ ุงูุฌุฏูุฏุฉ
    activateCardsForNewRound();
    
    renderFastEntryForm();
    updateDashboard();
    switchTab('round');
  });

  quickCalculateBtn.addEventListener('click', ()=>{
    switchTab('round');
    setTimeout(() => {
      finalizeBtn.click();
    }, 300);
  });

  // ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช ุงูุณุฑูุนุฉ
  document.querySelectorAll('.quick-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // ุญูุธ ุงููุฑุงุฑุงุช ูุจู ุงูุฎุฑูุฌ ูู ุตูุญุฉ ุงูุฌููุฉ
      if (document.getElementById('tab-round').style.display !== 'none') {
        saveDecisionsFromForm();
      }
      
      const action = btn.dataset.action;
      switch(action) {
        case 'add-players':
          switchTab('players');
          break;
        case 'start-round':
          state.round += 1;
          state.decisions.clear();
          state.attacksThisRound = [];
          resultsText.value='';
          roundNumberEl.textContent = state.round;
          
          // ุชูุนูู ุงูุจุทุงูุงุช ููุฌููุฉ ุงูุฌุฏูุฏุฉ
          activateCardsForNewRound();
          
          renderFastEntryForm();
          updateDashboard();
          switchTab('round');
          break;
        case 'manage-round':
          switchTab('round');
          break;
        case 'view-points':
          switchTab('points');
          break;
      }
    });
  });

  // ูุธุงุฆู ูุณุงุนุฏุฉ ุนุงูุฉ
  function switchTab(tab){
    tabs.forEach(b=>{
      b.classList.toggle('active', b.dataset.tab===tab);
    });
    Object.keys(sections).forEach(k=>{
      sections[k].style.display = (k===tab?'block':'none');
    });
    if(tab==='round') { 
      renderFastEntryForm();
      roundNumberEl.textContent = state.round; 
    }
    if(tab==='points') renderPointsTable();
    if(tab==='dashboard') updateDashboard();
  }
  
  function cryptoRandomId(){
    return 'p_' + Math.random().toString(36).slice(2,10);
  }

  // ุญูุธ ุงููุฑุงุฑุงุช ูู ุงููููุฐุฌ ุฅูู state.decisions
  function saveDecisionsFromForm() {
    fastEntryContainer.querySelectorAll('.fast-entry').forEach(entry=>{
      const pid = entry.dataset.pid;
      const action = entry.querySelector('select[data-field="action"]').value;
      const targetId = entry.querySelector('select[data-field="target"]').value || null;
      
      // ุญูุธ ููุท ุฅุฐุง ูุงู ููุงู ูููุฉ ูุญุฏุฏุฉ (ููุณุช ูุงุฑุบุฉ)
      if (action || targetId) {
        state.decisions.set(pid, {action,targetId,announcedAllianceWithId:null,usesCard:null});
      }
    });
  }

  // ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู
  function updateDashboard(){
    dashboardPlayerCount.textContent = state.players.length;
    dashboardRound.textContent = state.round;
    
    if(state.players.length > 0) {
      const topPlayer = state.players.reduce((prev, current) => 
        (prev.points > current.points) ? prev : current
      );
      dashboardTopScore.textContent = topPlayer.points;
      dashboardTopPlayer.textContent = topPlayer.name;
    } else {
      dashboardTopScore.textContent = '0';
      dashboardTopPlayer.textContent = 'ูุง ููุฌุฏ';
    }
    
    const totalCards = state.players.reduce((sum, player) => sum + player.cards.length, 0);
    dashboardCardsUsed.textContent = totalCards;
  }

  // ุนุฑุถ ุงููุงุนุจูู
  function renderPlayersList(){
    playersList.innerHTML='';
    state.players.forEach((p,index)=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <span class="name">${p.name}</span>
        <span class="small muted">ุงูููุงุท: ${p.points} | ุจุทุงูุงุช: ${p.cards.map(c=>c.name).join('ุ ')||'ูุงููุฌุฏ'}</span>
        <div class="actions-cell">
          <button class="btn ghost" data-action="edit" data-index="${index}">โ๏ธ ุชุนุฏูู</button>
          <button class="btn warn" data-action="remove" data-index="${index}">๐๏ธ ุฅุฒุงูุฉ</button>
        </div>
      `;
      playersList.appendChild(div);
    });
    playersCountInfo.textContent = state.players.length ? `ุนุฏุฏ ุงููุงุนุจูู: ${state.players.length}` : '';
  }

  // ุฅุฏุฎุงู ุณุฑูุน ูููุฑุงุฑุงุช
  function renderFastEntryForm(){
    fastEntryContainer.innerHTML='';
    if(state.players.length===0){
      fastEntryContainer.innerHTML='<div class="small muted">ุฃุถู ูุงุนุจูู ุฃููุงู.</div>';
      return;
    }
    
    state.players.forEach(p=>{
      const targets = state.players.filter(x=>x.id!==p.id);
      const entry = document.createElement('div');
      entry.className='fast-entry';
      entry.dataset.pid = p.id;
      entry.innerHTML = `
        <div class="player-name">${p.name}</div>
        <select data-field="action">
          <option value="">โ ุฅุฌุฑุงุก โ</option>
          <option value="attack">ูุฌูู</option>
          <option value="alliance">ุชุญุงูู</option>
          <option value="trade">ุชุฌุงุฑุฉ</option>
          <option value="betray">ุฎูุงูุฉ</option>
          <option value="none">ูุง ุดูุก</option>
        </select>
        <select data-field="target">
          <option value="">โ ูุฏู โ</option>
          ${targets.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
        </select>
      `;
      
      // ููุก ุงูููู ุงููุญููุธุฉ ุณุงุจููุง ูู state.decisions
      const saved = state.decisions.get(p.id);
      if(saved){
        entry.querySelector('select[data-field="action"]').value = saved.action || '';
        entry.querySelector('select[data-field="target"]').value = saved.targetId || '';
      }
      
      // ุฅุถุงูุฉ ูุณุชูุน ุญุฏุซ ูุญูุธ ุงูุชุบููุฑุงุช ุชููุงุฆููุง
      const actionSelect = entry.querySelector('select[data-field="action"]');
      const targetSelect = entry.querySelector('select[data-field="target"]');
      
      actionSelect.addEventListener('change', () => {
        state.decisions.set(p.id, {
          action: actionSelect.value,
          targetId: targetSelect.value || null,
          announcedAllianceWithId: null,
          usesCard: null
        });
      });
      
      targetSelect.addEventListener('change', () => {
        state.decisions.set(p.id, {
          action: actionSelect.value,
          targetId: targetSelect.value || null,
          announcedAllianceWithId: null,
          usesCard: null
        });
      });
      
      fastEntryContainer.appendChild(entry);
    });
  }

  // ุชูุนูู ุงูุจุทุงูุงุช ููุฌููุฉ ุงูุฌุฏูุฏุฉ
  function activateCardsForNewRound() {
    const activationLines = [];
    
    state.players.forEach(p => {
      // ุชูุนูู ุงูุจุทุงูุงุช ุงููุฎุฒูุฉ ููุฌููุฉ ุงูุญุงููุฉ
      const cardsToActivate = state.cardsToActivate.get(p.id) || [];
      
      cardsToActivate.forEach(cardKey => {
        const card = state.cardsCatalog[cardKey];
        if (card && !p.cards.some(c => c.key === cardKey)) {
          p.cards.push(card);
          activationLines.push(`${p.name} ูุงู ุจุชูุนูู ${card.name} (${card.desc})`);
        }
      });
      
      // ูุณุญ ุงูุจุทุงูุงุช ุงูุชู ุชู ุชูุนูููุง
      state.cardsToActivate.set(p.id, []);
    });
    
    // ุฅุถุงูุฉ ูุนูููุงุช ุชูุนูู ุงูุจุทุงูุงุช ุฅูู ุงููุชุงุฆุฌ ุฅุฐุง ูุงูุช ููุงู ุฌููุฉ ุณุงุจูุฉ
    if (activationLines.length > 0 && state.round > 1) {
      resultsText.value = "ุชูุนูู ุงูุจุทุงูุงุช ููุฌููุฉ " + state.round + ":\n" + 
                         activationLines.join('\n') + "\n\n" + 
                         (resultsText.value || '');
    }
  }

  // ุงูุญุณุงุจ ุงูููุทูู ููุฌููุฉ
  function computeResults(){
    const playersById = Object.fromEntries(state.players.map(p=>[p.id,p]));
    const alliances = new Map();      // id -> partnerId (ุฅู ูุงู ูุชุจุงุฏููุง ูุตุจุญ ูุงุฌุญ)
    const trades = new Map();         // id -> partnerId (ุฅู ูุงูุช ูุชุจุงุฏูุฉ ุชุตุจุญ ูุงุฌุญุฉ)
    const attacks = [];               // {attackerId,targetId}
    const betrays = [];               // {betrayerId,targetId}
    const shieldsUsed = new Set();    // playerId (ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ ุชููุงุฆููุง)
    const doubleAttackUsed = new Set(); // playerId (ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ ุชููุงุฆููุง)
    const doubleTradeUsed = new Set();  // playerId (ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ ุชููุงุฆููุง)
    const textLines = [`ุงูุฌููุฉ ${state.round}:`];

    // ุชุทุจูู ุงูุจุทุงูุงุช ุงูุชููุงุฆูุฉ ุฃููุงู
    applyAutomaticCards(playersById, shieldsUsed, doubleAttackUsed, doubleTradeUsed, textLines);

    // ุชุฌููุน ุงููุฑุงุฑุงุช
    state.decisions.forEach((d, pid)=>{
      const p = playersById[pid];
      if(!p) return;
      const targetName = d.targetId ? playersById[d.targetId]?.name : '';
      
      // ุงูุฅุฌุฑุงุกุงุช
      if(d.action==='alliance' && d.targetId){
        alliances.set(pid, d.targetId);
        textLines.push(`${p.name} ุฃุนูู ุชุญุงูููุง ูุน ${targetName}.`);
      } else if(d.action==='trade' && d.targetId){
        trades.set(pid, d.targetId);
        textLines.push(`${p.name} ุนูุฏ ุชุฌุงุฑุฉ ูุน ${targetName}.`);
      } else if(d.action==='attack' && d.targetId){
        attacks.push({attackerId:pid, targetId:d.targetId});
        textLines.push(`${p.name} ูุงุฌู ${targetName}.`);
      } else if(d.action==='betray' && d.targetId){
        betrays.push({betrayerId:pid, targetId:d.targetId});
        attacks.push({attackerId:pid, targetId:d.targetId});
        textLines.push(`${p.name} ุฎุงู ${targetName} ููุงุฌูู.`);
      } else if(d.action==='none'){
        textLines.push(`${p.name} ูู ูุชุฎุฐ ุฅุฌุฑุงุกู.`);
      }
    });

    // ุชุญุฏูุฏ ุงูุชุญุงููุงุช ุงููุงุฌุญุฉ (ูุชุจุงุฏูุฉ)
    const successfulAlliances = new Map();
    alliances.forEach((partner, id)=>{
      if(alliances.get(partner)===id){
        successfulAlliances.set(id, partner);
        successfulAlliances.set(partner, id);
      }
    });

    // ุชุญุฏูุฏ ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ (ูุชุจุงุฏูุฉ)
    const successfulTrades = new Map();
    trades.forEach((partner, id)=>{
      if(trades.get(partner)===id){
        successfulTrades.set(id, partner);
        successfulTrades.set(partner, id);
      }
    });

    // ูุชุงุฆุฌ ุงููุฌูุงุช
    const attackResults = []; // {attackerId,targetId,success,pointsAwarded,reason}
    attacks.forEach(atk=>{
      const targetAlliancePartner = successfulAlliances.get(atk.targetId);
      const targetShielded = shieldsUsed.has(atk.targetId);
      let success = true;
      let reason = '';
      if(targetShielded){
        success = false;
        reason = 'ุงููุฌูู ูุดู ุจุณุจุจ ุงูุญุตุงูุฉ';
      } else if(targetAlliancePartner){
        success = false;
        reason = 'ุงููุฌูู ูุดู ุจุณุจุจ ุชุญุงูู ูุงุฌุญ';
      }
      const points = success ? (doubleAttackUsed.has(atk.attackerId) ? 4 : 2) : 0;
      attackResults.push({attackerId:atk.attackerId,targetId:atk.targetId,success:success,pointsAwarded:points,reason});
    });

    // ูุต ุชูุตููู
    const detailedLines = [];
    // ุงูุชุญุงููุงุช ุงููุงุฌุญุฉ
    const printedAlliances = new Set();
    successfulAlliances.forEach((partner,id)=>{
      if(printedAlliances.has(id) || printedAlliances.has(partner)) return;
      const tradePoints1 = (doubleTradeUsed.has(id)?2:1);
      const tradePoints2 = (doubleTradeUsed.has(partner)?2:1);
      detailedLines.push(`ุชุญุงูู ูุงุฌุญ ุจูู ${playersById[id].name} ู${playersById[partner].name} (${tradePoints1} ููุทุฉ ูู ${playersById[id].name}ุ ู${tradePoints2} ููุทุฉ ูู ${playersById[partner].name}).`);
      printedAlliances.add(id); printedAlliances.add(partner);
    });
    // ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ
    const printedTrades = new Set();
    successfulTrades.forEach((partner,id)=>{
      if(printedTrades.has(id) || printedTrades.has(partner)) return;
      const p1 = playersById[id], p2 = playersById[partner];
      const tradePoints1 = (doubleTradeUsed.has(id)?2:1);
      const tradePoints2 = (doubleTradeUsed.has(partner)?2:1);
      detailedLines.push(`ุชุฌุงุฑุฉ ูุงุฌุญุฉ ุจูู ${p1.name} ู${p2.name} (${tradePoints1} ููุทุฉ ูู ${p1.name}ุ ู${tradePoints2} ููุทุฉ ูู ${p2.name}).`);
      printedTrades.add(id); printedTrades.add(partner);
    });
    // ูุชูุฌุฉ ุงููุฌูุงุช
    attackResults.forEach(res=>{
      const attacker = playersById[res.attackerId].name;
      const target = playersById[res.targetId].name;
      if(res.success){
        detailedLines.push(`ูุฌูู ูุงุฌุญ: ${attacker} ุนูู ${target} (+${res.pointsAwarded} ููุงุท${doubleAttackUsed.has(res.attackerId) ? ' ุจุงุณุชุฎุฏุงู ุจุทุงูุฉ ุงููุฌูู ุงููุถุงุนู' : ''}).`);
      } else {
        detailedLines.push(`ูุฌูู ูุงุดู: ${attacker} ุนูู ${target} (${res.reason}).`);
      }
    });

    // ุญูุธ ูุชูููู ุงูุฅูุตุงุก ุงูุชููุงุฆู (ูุฌููุงู ุนูู ููุณ ุงููุฏู)
    state.attacksThisRound = attackResults.map(r=>({attackerId:r.attackerId,targetId:r.targetId,success:r.success}));

    // ููุญ ุจุทุงูุฉ ุงููุดู ููุฎููุฉ ุงููุงุฌุญูู
    const revealWinners = [];
    betrays.forEach(b=>{
      // ุชุญูู ููุง ุฅุฐุง ูุงู ุงููุฏู ูุฏ ุงุฎุชุงุฑ ุชุญุงูู ูุน ุงูุฎุงุฆู
      const targetChoseAlliance = alliances.get(b.targetId) === b.betrayerId;
      if(targetChoseAlliance){
        const found = attackResults.find(r=>r.attackerId===b.betrayerId && r.targetId===b.targetId && r.success);
        if(found) revealWinners.push(b.betrayerId);
      }
    });
    revealWinners.forEach(id=>{
      detailedLines.push(`ุจุทุงูุฉ ุงููุดู: ${playersById[id].name} ุญุตู ุนูููุง ูุฎูุงูุฉ ูุงุฌุญุฉ ุถุฏ ูุงุนุจ ูุงู ูุฏ ุงุฎุชุงุฑ ุงูุชุญุงูู ูุนู.`);
    });

    const text = [...textLines, '', ...detailedLines].join('\n');
    return {
      text,
      successfulAlliances,
      successfulTrades,
      attackResults,
      shieldsUsed,
      doubleAttackUsed,
      doubleTradeUsed,
      revealWinners
    };
  }

  // ุชุทุจูู ุงูุจุทุงูุงุช ุงูุชููุงุฆูุฉ
  function applyAutomaticCards(playersById, shieldsUsed, doubleAttackUsed, doubleTradeUsed, textLines) {
    const cardActivationLines = [];
    
    state.players.forEach(p => {
      // ุงูุชุญูู ูู ุงูุจุทุงูุงุช ุงูุชู ููุชูููุง ุงููุงุนุจ ูุชุทุจูููุง ุชููุงุฆููุง
      p.cards.forEach(card => {
        switch(card.key) {
          case 'shield':
            // ุจุทุงูุฉ ุงูุญุตุงูุฉ: ุชููุน ุฃูู ูุฌูู ุถุฏ ุงููุงุนุจ ูู ูุฐู ุงูุฌููุฉ
            shieldsUsed.add(p.id);
            cardActivationLines.push(`${p.name} ูุณุชุฎุฏู ุจุทุงูุฉ ุงูุญุตุงูุฉ ุชููุงุฆููุง (ุณุชููุน ุฃูู ูุฌูู ุถุฏู).`);
            // ุฅุฒุงูุฉ ุงูุจุทุงูุฉ ุจุนุฏ ุงุณุชุฎุฏุงููุง
            p.cards = p.cards.filter(c => c.key !== 'shield');
            break;
            
          case 'doubleAttack':
            // ุจุทุงูุฉ ุงููุฌูู ุงููุถุงุนู: ุชุถุงุนู ููุงุท ุงููุฌูู ุฅุฐุง ุงุฎุชุงุฑ ุงููุงุนุจ ูุฌูููุง ุฃู ุฎูุงูุฉ
            const playerDecision = state.decisions.get(p.id);
            if (playerDecision && (playerDecision.action === 'attack' || playerDecision.action === 'betray')) {
              doubleAttackUsed.add(p.id);
              cardActivationLines.push(`${p.name} ูุณุชุฎุฏู ุจุทุงูุฉ ุงููุฌูู ุงููุถุงุนู ุชููุงุฆููุง (ุณุชุถุงุนู ููุงุท ูุฌููู).`);
              // ุฅุฒุงูุฉ ุงูุจุทุงูุฉ ุจุนุฏ ุงุณุชุฎุฏุงููุง
              p.cards = p.cards.filter(c => c.key !== 'doubleAttack');
            }
            break;
            
          case 'doubleTrade':
            // ุจุทุงูุฉ ุงูุชุงุฌุฑ: ุชุถุงุนู ููุงุท ุงูุชุฌุงุฑุฉ ุฅุฐุง ุงุฎุชุงุฑ ุงููุงุนุจ ุชุฌุงุฑุฉ
            const tradeDecision = state.decisions.get(p.id);
            if (tradeDecision && tradeDecision.action === 'trade') {
              doubleTradeUsed.add(p.id);
              cardActivationLines.push(`${p.name} ูุณุชุฎุฏู ุจุทุงูุฉ ุงูุชุงุฌุฑ ุชููุงุฆููุง (ุณุชุถุงุนู ููุงุท ุชุฌุงุฑุชู).`);
              // ุฅุฒุงูุฉ ุงูุจุทุงูุฉ ุจุนุฏ ุงุณุชุฎุฏุงููุง
              p.cards = p.cards.filter(c => c.key !== 'doubleTrade');
            }
            break;
            
          case 'reveal':
            // ุจุทุงูุฉ ุงููุดู: ุชูุณุชุฎุฏู ุฎุงุฑุฌ ุงููุนุจุฉ ูุชูุณุชููู ุชููุงุฆููุง ูู ุงูุฌููุฉ ุงูุชุงููุฉ
            cardActivationLines.push(`${p.name} ููุชูู ุจุทุงูุฉ ุงููุดู (ููููู ุณุคุงู ุงููุถูู ุนู ูุฑุงุฑ ุฃู ูุงุนุจ ูู ุงูุฎุงุต).`);
            // ุฅุฒุงูุฉ ุงูุจุทุงูุฉ ุจุนุฏ ุงูุฌููุฉ
            p.cards = p.cards.filter(c => c.key !== 'reveal');
            break;
        }
      });
    });
    
    // ุฅุถุงูุฉ ูุนูููุงุช ุชูุนูู ุงูุจุทุงูุงุช ุฅูู ุงููุชุงุฆุฌ
    if (cardActivationLines.length > 0) {
      textLines.push('', 'ุชูุนูู ุงูุจุทุงูุงุช ุงูุชููุงุฆู:');
      cardActivationLines.forEach(line => textLines.push(line));
    }
  }

  // ุชุทุจูู ุงูููุงุท
  function applyPoints(calc){
    const byId = Object.fromEntries(state.players.map(p=>[p.id,p]));
    const didAttackSuccess = new Map(); // id -> bool
    state.players.forEach(p=>didAttackSuccess.set(p.id,false));

    // ุงูุชุญุงููุงุช ุงููุงุฌุญุฉ
    const countedAlliances = new Set();
    calc.successfulAlliances.forEach((partner,id)=>{
      if(countedAlliances.has(id) || countedAlliances.has(partner)) return;
      const pts1 = calc.doubleTradeUsed.has(id) ? 2 : 1;
      const pts2 = calc.doubleTradeUsed.has(partner) ? 2 : 1;
      byId[id].points += pts1;
      byId[partner].points += pts2;
      byId[id].loyalAlliances += 1;
      byId[partner].loyalAlliances += 1;
      countedAlliances.add(id); countedAlliances.add(partner);
    });

    // ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ
    const countedTrades = new Set();
    calc.successfulTrades.forEach((partner,id)=>{
      if(countedTrades.has(id) || countedTrades.has(partner)) return;
      const pts1 = calc.doubleTradeUsed.has(id) ? 2 : 1;
      const pts2 = calc.doubleTradeUsed.has(partner) ? 2 : 1;
      byId[id].points += pts1; byId[partner].points += pts2;
      byId[id].tradeCount += 1; byId[partner].tradeCount += 1;
      countedTrades.add(id); countedTrades.add(partner);
    });

    // ุงููุฌูุงุช
    calc.attackResults.forEach(r=>{
      if(r.success){
        byId[r.attackerId].points += r.pointsAwarded;
        didAttackSuccess.set(r.attackerId,true);
      }
    });

    // ุชุญุฏูุซ ุณูุงุณู ุงููุฌูู
    state.players.forEach(p=>{
      if(didAttackSuccess.get(p.id)) p.streakAttack += 1;
      else p.streakAttack = 0;
    });
  }

  // ููุญ ุงูุจุทุงูุงุช ุจุงูุฅูุฌุงุฒ
  function awardCards(calc){
    const newCardsLines = [];
    state.players.forEach(p=>{
      if(p.streakAttack>=2 && !state.cardsToActivate.get(p.id)?.includes('doubleAttack')){
        // ุชุฎุฒูู ุงูุจุทุงูุฉ ููุชูุนูู ูู ุงูุฌููุฉ ุงูุชุงููุฉ
        if (!state.cardsToActivate.has(p.id)) state.cardsToActivate.set(p.id, []);
        state.cardsToActivate.get(p.id).push('doubleAttack');
        newCardsLines.push(`${p.name} ุณูุญุตู ุนูู ุจุทุงูุฉ ุงููุฌูู ุงููุถุงุนู ูู ุงูุฌููุฉ ุงูุชุงููุฉ ูุชูููุฐ ูุฌูููู ูุงุฌุญูู ูุชุชุงูููู.`);
      }
      if(p.loyalAlliances>=2 && !state.cardsToActivate.get(p.id)?.includes('shield')){
        // ุชุฎุฒูู ุงูุจุทุงูุฉ ููุชูุนูู ูู ุงูุฌููุฉ ุงูุชุงููุฉ
        if (!state.cardsToActivate.has(p.id)) state.cardsToActivate.set(p.id, []);
        state.cardsToActivate.get(p.id).push('shield');
        newCardsLines.push(`${p.name} ุณูุญุตู ุนูู ุจุทุงูุฉ ุงูุญุตุงูุฉ ูู ุงูุฌููุฉ ุงูุชุงููุฉ ูุฅุจุฑุงู ุชุญุงูููู ูุงุฌุญูู.`);
      }
      if(p.tradeCount>=3 && !state.cardsToActivate.get(p.id)?.includes('doubleTrade')){
        // ุชุฎุฒูู ุงูุจุทุงูุฉ ููุชูุนูู ูู ุงูุฌููุฉ ุงูุชุงููุฉ
        if (!state.cardsToActivate.has(p.id)) state.cardsToActivate.set(p.id, []);
        state.cardsToActivate.get(p.id).push('doubleTrade');
        newCardsLines.push(`${p.name} ุณูุญุตู ุนูู ุจุทุงูุฉ ุงูุชุงุฌุฑ ูู ุงูุฌููุฉ ุงูุชุงููุฉ ูุฅุชูุงู ุซูุงุซ ุตููุงุช ุชุฌุงุฑูุฉ ูุงุฌุญุฉ.`);
      }
    });
    
    // ููุญ ุจุทุงูุงุช ุงููุดู ููุฎููุฉ ุงููุงุฌุญูู
    calc.revealWinners.forEach(id=>{
      const p = state.players.find(player => player.id === id);
      if (p && !state.cardsToActivate.get(p.id)?.includes('reveal')) {
        // ุชุฎุฒูู ุงูุจุทุงูุฉ ููุชูุนูู ูู ุงูุฌููุฉ ุงูุชุงููุฉ
        if (!state.cardsToActivate.has(p.id)) state.cardsToActivate.set(p.id, []);
        state.cardsToActivate.get(p.id).push('reveal');
        newCardsLines.push(`${p.name} ุณูุญุตู ุนูู ุจุทุงูุฉ ุงููุดู ูู ุงูุฌููุฉ ุงูุชุงููุฉ ูุฎูุงูุฉ ูุงุฌุญุฉ ุถุฏ ูุงุนุจ ูุงู ูุฏ ุงุฎุชุงุฑ ุงูุชุญุงูู ูุนู.`);
      }
    });
    
    // ุฅุถุงูุฉ ูุนูููุงุช ุงูุจุทุงูุงุช ุงูููุชุณุจุฉ ุญุฏูุซูุง ุฅูู ุงููุชุงุฆุฌ
    if (newCardsLines.length > 0) {
      resultsText.value += "\n\nุงูุจุทุงูุงุช ุงูุชู ุณูุญุตู ุนูููุง ุงููุงุนุจูู ูู ุงูุฌููุฉ ุงูุชุงููุฉ:\n" + newCardsLines.join('\n');
    }
  }

  // ุฌุฏูู ุงูููุงุท ูุงูุจุทุงูุงุช
  function renderPointsTable(){
    pointsTableBody.innerHTML='';
    state.players.forEach(p=>{
      const tr = document.createElement('tr');
      const cardsText = p.cards.map(c=>c.name).join('ุ ') || 'โ';
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.points}</td>
        <td>${p.streakAttack}</td>
        <td>${p.loyalAlliances}</td>
        <td>${p.tradeCount}</td>
        <td>${cardsText}</td>
      `;
      pointsTableBody.appendChild(tr);
    });
  }

  // ุงูุฅูุตุงุก ุงูุชููุงุฆู
  function performAutoElimination(){
    const eliminationLines = [];
    const byId = Object.fromEntries(state.players.map(p=>[p.id,p]));

    // 1) ุงูุฅูุตุงุก ุจุณุจุจ ูุฌูููู ูุงุฌุญูู ุฃู ุฃูุซุฑ ูู ููุณ ุงูุฌููุฉ
    const successAttacks = state.attacksThisRound.filter(a=>a.success);
    const targetsCount = {};
    successAttacks.forEach(a=>{
      targetsCount[a.targetId] = (targetsCount[a.targetId]||0)+1;
    });
    
    const attackedPlayers = Object.entries(targetsCount).filter(([tid,count])=>count>=2);
    attackedPlayers.forEach(([targetId, count])=>{
      const name = byId[targetId]?.name || 'ูุงุนุจ';
      eliminationLines.push(`ุชู ุฅูุตุงุก ${name} ูุชุนุฑุถู ูู ${count} ูุฌูู(ุงุช) ูุงุฌุญ(ุฉ) ูู ููุณ ุงูุฌููุฉ.`);
      removePlayerById(targetId);
    });

    // 2) ุงูุฅูุตุงุก ุจุณุจุจ ุงูุฃูู ููุงุทูุง ูู ุฌููุชูู ูุชุชุงููุชูู (ุจุฏุกูุง ูู ุงูุฌููุฉ ุงูุซุงููุฉ)
    if (state.round >= 2 && state.lastRoundPointsSnapshot.size > 0) {
      const prevMin = Math.min(...Array.from(state.lastRoundPointsSnapshot.values()));
      const prevIds = Array.from(state.lastRoundPointsSnapshot.entries())
        .filter(([id,pts])=>pts===prevMin)
        .map(([id])=>id);
      
      const currentMin = Math.min(...state.players.map(p=>p.points));
      const currentIds = state.players.filter(p=>p.points===currentMin).map(p=>p.id);
      
      // ุชูุงุทุน: ุงููุงุนุจูู ุงูุฐูู ูุงููุง ุงูุฃูู ููุงุทูุง ูู ุงูุฌููุฉ ุงูุณุงุจูุฉ ูุงูุญุงููุฉ
      const intersection = prevIds.filter(id=>currentIds.includes(id));
      
      if(intersection.length > 0){
        const names = intersection.map(id => byId[id]?.name).join('ุ ');
        eliminationLines.push(`ุชู ุฅูุตุงุก ${names} ูููููู ุงูุฃูู ููุงุทูุง ูู ุฌููุชูู ูุชุชุงููุชูู.`);
        
        // ุฅุฒุงูุฉ ุฌููุน ุงููุงุนุจูู ุงููุชุนุงุฏููู ูู ุงููุงุน
        intersection.forEach(id => removePlayerById(id));
      }
    }

    return eliminationLines.length > 0 ? "ูุชุงุฆุฌ ุงูุฅูุตุงุก ุงูุชููุงุฆู:\n" + eliminationLines.join('\n') : "";
  }

  // ุฅุฒุงูุฉ ูุงุนุจ ุนุจุฑ id
  function removePlayerById(id){
    const idx = state.players.findIndex(p=>p.id===id);
    if(idx>=0){
      const removed = state.players.splice(idx,1)[0];
      // ุชูุธูู ุงููุฑุงุฑุงุช
      state.decisions.delete(removed.id);
      state.decisions.forEach((d,pid)=>{
        if(d.targetId===removed.id) d.targetId = null;
        if(d.announcedAllianceWithId===removed.id) d.announcedAllianceWithId = null;
      });
      // ุชูุธูู ุงูุจุทุงูุงุช ุงููุฎุฒูุฉ
      state.cardsToActivate.delete(removed.id);
    }
  }

  // ุจุฏุงูุฉ
  renderPlayersList();
  updateDashboard();

})();
</script>
</body>
</html>
