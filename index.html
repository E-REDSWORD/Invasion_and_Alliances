<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>REDSWORD Games - ููุญุฉ ุงููุดุฑู | ุงูุบุฒู ูุงูุชุญุงููุงุช</title>
  <style>
    :root{
      --bg:#f7f7f9;
      --card:#ffffff;
      --text:#1a1a1b;
      --muted:#68686b;
      --accent:#c00000; /* REDSWORD */
      --accent-dark:#8f0000;
      --border:#e5e6ea;
      --ok:#0a7d33;
      --warn:#cc7a00;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic","Noto Sans Arabic",Tahoma,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      background:var(--card); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    .brand{
      display:flex; align-items:center; gap:.75rem; padding:.9rem 1rem;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:8px; background:var(--accent);
      display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800;
      box-shadow:0 2px 8px rgba(192,0,0,.25);
    }
    .brand .titles{display:flex; flex-direction:column; line-height:1.2}
    .brand .titles .site{font-weight:800}
    .brand .titles .game{font-size:.9rem; color:var(--muted)}
    main{padding:1rem; max-width:900px; margin:0 auto;}

    .nav{
      display:grid; grid-template-columns:1fr; gap:.5rem; margin: .5rem 0 1rem;
    }
    .nav button{
      width:100%; padding:.8rem 1rem; border:1px solid var(--border);
      background:var(--card); border-radius:10px; font-weight:700; color:var(--text); cursor:pointer;
    }
    .nav button.active{border-color:var(--accent); box-shadow:0 0 0 3px rgba(192,0,0,.12)}

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1rem; margin-bottom:1rem;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    h2{margin:.2rem 0 1rem; font-size:1.1rem}
    .row{display:grid; grid-template-columns:1fr; gap:.75rem}
    @media (min-width:640px){ .row-2{grid-template-columns:1fr 1fr} }
    label{font-size:.9rem; color:var(--muted); display:block; margin-bottom:.25rem}
    input[type="text"], select{
      width:100%; padding:.7rem .8rem; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
      appearance:none;
    }
    .btn{
      display:inline-flex; align-items:center; gap:.5rem; padding:.75rem 1rem; border:none; border-radius:10px; font-weight:800; cursor:pointer;
    }
    .btn.primary{background:var(--accent); color:#fff}
    .btn.primary:active{background:var(--accent-dark)}
    .btn.ghost{background:var(--card); border:1px solid var(--border)}
    .btn.success{background:var(--ok); color:#fff}
    .btn.warn{background:var(--warn); color:#fff}
    .stack{display:flex; flex-wrap:wrap; gap:.6rem}
    .list{display:grid; grid-template-columns:1fr; gap:.5rem}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      padding:.6rem .8rem; border:1px solid var(--border); border-radius:10px; background:#fff;
    }
    .item .name{font-weight:700}
    .small{font-size:.85rem; color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .5rem; border-radius:8px; border:1px solid var(--border);
      background:#fafafa; font-size:.85rem;
    }
    .grid{display:grid; grid-template-columns:1fr; gap:.75rem}
    @media (min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}}
    .table{width:100%; border-collapse:collapse; font-size:.95rem}
    .table th, .table td{border:1px solid var(--border); padding:.6rem .5rem; text-align:center}
    .table th{background:#fafafa}
    .muted{color:var(--muted)}
    textarea{
      width:100%; min-height:120px; padding:.8rem; border:1px solid var(--border); border-radius:10px; resize:vertical;
      background:#fff; color:var(--text); font-family:inherit;
    }
    .footer{padding:1rem; text-align:center; color:var(--muted); font-size:.85rem}
    .actions-cell{display:flex; gap:.4rem; justify-content:center; flex-wrap:wrap}
    .hint{font-size:.85rem; color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">RS</div>
    <div class="titles">
      <div class="site">REDSWORD Games</div>
      <div class="game">ููุญุฉ ุงููุดุฑู โ ูุนุจุฉ ุงูุบุฒู ูุงูุชุญุงููุงุช</div>
    </div>
  </div>
</header>

<main>
  <div class="nav">
    <button class="active" data-tab="players">ุฅุถุงูุฉ ุงููุงุนุจูู</button>
    <button data-tab="round">ุฅุฏุงุฑุฉ ุงูุฌููุฉ</button>
    <button data-tab="points">ุงูููุงุท ูุงูุจุทุงูุงุช</button>
    <button data-tab="elimination">ุงูุฅูุตุงุก</button>
    <button data-tab="help">ุชุนูููุงุช ููุณุนุฉ</button>
  </div>

  <!-- ุฅุถุงูุฉ ุงููุงุนุจูู -->
  <section class="card" id="tab-players">
    <h2>ุฅุถุงูุฉ ุงููุงุนุจูู</h2>
    <div class="row row-2">
      <div>
        <label>ุงุณู ุงูุฏููุฉ/ุงููุจููุฉ</label>
        <input type="text" id="playerName" placeholder="ูุซุงู: ุฅูุจุฑุงุทูุฑูุฉ ุงูุตุญุฑุงุก" />
        <div class="hint">ุฅุฐุง ุชุฑูุช ุงูุงุณู ูุงุฑุบูุง ุณููุถุงู ุจุงุณู ุชููุงุฆู: "ูุงุนุจ 1"ุ "ูุงุนุจ 2"...</div>
      </div>
      <div class="stack" style="align-items:flex-end">
        <button class="btn primary" id="addPlayerBtn">ุฅุถุงูุฉ ูุงุนุจ</button>
        <button class="btn ghost" id="clearPlayersBtn">ูุณุญ ุงููุงุนุจูู</button>
      </div>
    </div>
    <div style="margin-top:.75rem">
      <div class="small">ุงููุงุนุจูู ุงููุถุงููู:</div>
      <div id="playersList" class="list"></div>
    </div>
    <div style="margin-top:1rem" class="stack">
      <button class="btn success" id="startGameBtn">ุจุฏุก ุงูุฌููุฉ ุงูุฃููู</button>
      <span class="small muted" id="playersCountInfo"></span>
    </div>
  </section>

  <!-- ุฅุฏุงุฑุฉ ุงูุฌููุฉ -->
  <section class="card" id="tab-round" style="display:none">
    <h2>ุฅุฏุงุฑุฉ ุงูุฌููุฉ</h2>
    <div class="stack" style="margin-bottom:.75rem">
      <div class="tag">ุงูุฌููุฉ ุงูุญุงููุฉ: <span id="roundNumber">1</span></div>
      <button class="btn ghost" id="newRoundBtn">ุจุฏุก ุฌููุฉ ุฌุฏูุฏุฉ</button>
    </div>

    <div id="decisionsContainer" class="grid grid-2"></div>

    <div style="margin-top:1rem" class="stack">
      <button class="btn primary" id="finalizeBtn">ุฅุนูุงู ุงููุชุงุฆุฌ ูุญุณุงุจ ุงูููุงุท</button>
      <button class="btn ghost" id="resetDecisionsBtn">ูุณุญ ุงููุฑุงุฑุงุช</button>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>ูุชุงุฆุฌ ุงูุฌููุฉ</h2>
      <textarea id="resultsText" readonly placeholder="ุณูุธูุฑ ููุง ูุต ุงููุชุงุฆุฌ ุงูุฌุงูุฒ ูููุฑุงุกุฉ..."></textarea>
      <div class="stack" style="margin-top:.6rem">
        <button class="btn primary" id="copyResultsBtn">ูุณุฎ ุงููุชุงุฆุฌ ููุต</button>
      </div>
    </div>
  </section>

  <!-- ุงูููุงุท ูุงูุจุทุงูุงุช -->
  <section class="card" id="tab-points" style="display:none">
    <h2>ุงูููุงุท ูุงูุจุทุงูุงุช ุงูุฎุงุตุฉ</h2>
    <div style="overflow:auto">
      <table class="table" id="pointsTable">
        <thead>
          <tr>
            <th>ุงููุงุนุจ</th>
            <th>ุงูููุงุท</th>
            <th>ูุฌูุงุช ูุงุฌุญุฉ ูุชุชุงููุฉ</th>
            <th>ุชุญุงููุงุช ููุงุก</th>
            <th>ุตููุงุช ุชุฌุงุฑุฉ</th>
            <th>ุจุทุงูุงุช</th>
            <th>ุงุณุชุฎุฏุงู ุจุทุงูุฉ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ุงูุฅูุตุงุก -->
  <section class="card" id="tab-elimination" style="display:none">
    <h2>ุงูุฅูุตุงุก</h2>
    <div class="hint">ุงูุฅูุตุงุก ูุทุจู ุจููุงูุฉ ุงูุฌููุฉ ููู ูุนุงููุฑ ุนุงุฏูุฉ. ุงุฎุชุฑ ูุนูุงุฑูุง ุฃู ุงุณุชุฎุฏู ุงูุชุญูู ุงูุชููุงุฆู.</div>
    <div class="row row-2" style="margin-top:.75rem">
      <div>
        <label>ุงููุนูุงุฑ</label>
        <select id="elimCriterion">
          <option value="auto">ุชุญูู ุชููุงุฆู (ูุฌููุงู ูุงุฌุญุงู ูู ููุณ ุงูุฌููุฉ โ ุฅูุตุงุก)</option>
          <option value="lowestTwoRounds">ุงูุฃูู ููุงุทูุง ูุฌููุชูู ูุชุชุงููุชูู</option>
          <option value="failedBetrayTwice">ุฎูุงูุฉ ููุนููุฉ ูุงุดูุฉ ูุฑุชูู ุฎูุงู ุซูุงุซ ุฌููุงุช</option>
          <option value="manualVote">ุชุตููุช ูุญุฏูุฏ (ูุฏูู)</option>
        </select>
      </div>
      <div>
        <label>ูุฑุดุญ ุงูุฅูุตุงุก (ุงุฎุชูุงุฑู)</label>
        <select id="elimCandidate">
          <option value="">โ ุงุฎุชุฑ ูุงุนุจูุง (ูููุนุงููุฑ ุงููุฏููุฉ) โ</option>
        </select>
      </div>
    </div>
    <div class="stack" style="margin-top:.75rem">
      <button class="btn warn" id="checkEliminationBtn">ุชุญูู/ูููุฐ ุงูุฅูุตุงุก</button>
    </div>
    <div class="card" style="margin-top:1rem">
      <h2>ูุต ุฅุนูุงู ุงูุฅูุตุงุก</h2>
      <textarea id="elimText" readonly placeholder="ุณูุธูุฑ ููุง ูุต ุงูุฅูุตุงุก ุฅู ุชุญูู..."></textarea>
      <div class="stack" style="margin-top:.6rem">
        <button class="btn primary" id="copyElimBtn">ูุณุฎ ูุต ุงูุฅูุตุงุก</button>
      </div>
    </div>
  </section>

  <!-- ุชุนูููุงุช ููุณุนุฉ -->
  <section class="card" id="tab-help" style="display:none">
    <h2>ุชุนูููุงุช ุงููุนุจุฉ โ ููุงุนุจูู ูุงููุดุฑู</h2>

    <div class="card">
      <h2>ุชุนูููุงุช ุงููุงุนุจูู</h2>
      <ul class="list">
        <li class="item"><span class="name">ุงูุฏูุฑ</span><span class="small">ุชูุซู ุฏููุฉ/ูุจููุฉ. ูููุชู ูู ุงูุญููุฉ ูุงูุชุญุงูู ูุงูุฎุฏุงุน.</span></li>
        <li class="item"><span class="name">ุงููุฑุงุฑุงุช ุงูููููุฉ</span><span class="small">ูุฌููุ ุชุญุงููุ ุชุฌุงุฑุฉุ ุฎูุงูุฉ (ุฅู ุฃุนููุช ุชุญุงูููุง ุนููููุง)ุ ุฃู ูุง ุดูุก.</span></li>
        <li class="item"><span class="name">ุงูููุงุด ุงูุนููู</span><span class="small">ุงุจูู ุณุฑุฏู: ุชูุงูุถุ ูุฏูุฏุ ุดููุด. ูุง ุชูููู ุนูููุง ูุง ูุณุงูู ุงูุชูููุฐ ุงูุณุฑู.</span></li>
        <li class="item"><span class="name">ุงูุฅุฑุณุงู ุงูุณุฑู</span><span class="small">ุฃุฑุณู ูุฑุงุฑู ูููุดุฑู ูู ุงูุฎุงุต ุจุฏูุฉ (ุงููุนู + ุงููุฏู/ุงูุดุฑูู).</span></li>
        <li class="item"><span class="name">ุงูููุงุท</span><span class="small">ูุฌูู ูุงุฌุญ +2 (ุฃู +4 ูุน ุจุทุงูุฉ)ุ ุชุญุงูู ูุชุจุงุฏู +1 ููู ุทุฑูุ ุชุฌุงุฑุฉ ูุชุจุงุฏูุฉ +1 (ุฃู +2 ูุน ุจุทุงูุฉ).</span></li>
        <li class="item"><span class="name">ุงูุจุทุงูุงุช ุจุงูุฅูุฌุงุฒ</span><span class="small">ูุฌูููู ูุชุชุงููู โ ูุฌูู ูุถุงุนูุ ุชุญุงูููู ููุงุก โ ุญุตุงูุฉุ ุซูุงุซ ุชุฌุงุฑุงุช โ ุชุงุฌุฑุ ุฎูุงูุฉ ููุนููุฉ ูุงุฌุญุฉ โ ุฎูุงูุฉ ุฐูุจูุฉ.</span></li>
        <li class="item"><span class="name">ุงุณุชุฑุงุชูุฌูุงุช</span><span class="small">ุงุจูู ุณูุนุฉุ ุดููุด ุงูููุงูุงุ ุงูุฑุฃ ุฎุตูููุ ููุงุฒู ุงููุฎุงุทุฑ.</span></li>
      </ul>
    </div>

    <div class="card">
      <h2>ุชุนูููุงุช ุงููุดุฑู</h2>
      <ul class="list">
        <li class="item"><span class="name">ุฅุฏุงุฑุฉ ุงูุฌููุฉ</span><span class="small">ุงูุชุญ ููุงุดูุง ุนููููุง ูุตูุฑูุงุ ุซู ุฃุฏุฎู ุงููุฑุงุฑุงุช ุงูุณุฑูุฉ ูู ุงูุตูุญุฉ. ุฒุฑ ุงูุญุณุงุจ ูุญูุธ ููุญุณุจ ุฏูุนุฉ ูุงุญุฏุฉ.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงูุชุญุงูู</span><span class="small">ูุง ููุทุฉ ุฅูุง ุฅุฐุง ูุงู ุงูุชุญุงูู ูุชุจุงุฏููุง ุณุฑูุง. ูููุน ุงููุฌูุงุช ุนูู ุงูุทุฑููู ูู ุชูู ุงูุฌููุฉ.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงูุชุฌุงุฑุฉ</span><span class="small">ููุทุฉ ููู ุทุฑู ุนูุฏ ุงูุชุจุงุฏู ุงููุชุจุงุฏู. ูุน ุจุทุงูุฉ ุงูุชุงุฌุฑ ุชุตุจุญ ููุทุชูู.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงููุฌูู</span><span class="small">ููุดู ุงููุฌูู ุฅู ูุงู ุงููุฏู ูุชุญุงูููุง ุฃู ุงุณุชุฎุฏู ุญุตุงูุฉ. ููุฌุญ ุฅู ูู ููู ูุญูููุง.</span></li>
        <li class="item"><span class="name">ููุงุนุฏ ุงูุฎูุงูุฉ</span><span class="small">ูุง ุชูุนุชุจุฑ ุฎูุงูุฉ ุฅูุง ุฅุฐุง ุฃุนูู ุงููุงุนุจ ุงูุชุญุงูู ุนูููุง ุซู ุฃุฑุณู "ุฎูุงูุฉ" ูุน ูุฌูู. ุฅู ูุฌุญุช ุชูููุญ ุงูุฎูุงูุฉ ุงูุฐูุจูุฉ.</span></li>
        <li class="item"><span class="name">ุงูุฅูุตุงุก</span><span class="small">ุจููุงูุฉ ุงูุฌููุฉ: ูุฌููุงู ูุงุฌุญุงู ุนูู ููุณ ุงููุงุนุจ โ ุฅูุตุงุก ุชููุงุฆู. ุจุฏุงุฆู: ุงูุฃูู ููุงุทูุง ูุฌููุชููุ ุฃู ุฎูุงูุฉ ููุนููุฉ ูุงุดูุฉ ูุฑุชูู ุฎูุงู ุซูุงุซ ุฌููุงุชุ ุฃู ุชุตููุช ูุญุฏูุฏ.</span></li>
        <li class="item"><span class="name">ูุตูุต ุงูุฅุนูุงู</span><span class="small">ุงุณุชุฎุฏู ุงููุตูุต ุงูุฌุงูุฒุฉ ูู ุตูุญุฉ ุงูุฌููุฉ ูุงูุฅูุตุงุก ูุงูุฑุฃูุง ูู ุงูุบุฑูุฉ ุจุนุฏ ุงููุณุฎ.</span></li>
      </ul>
    </div>

    <div class="card">
      <h2>ุญุงูุงุช ุฎุงุตุฉ</h2>
      <ul class="list">
        <li class="item"><span class="name">ูุฌููุงู ูุชูุงุจูุงู</span><span class="small">ูููููู ูู ูุฌูู ูุณุชูููุง ููู ุญูุงูุฉ ุงููุฏู.</span></li>
        <li class="item"><span class="name">ุฎูุงูุฉ ุจุฏูู ุฅุนูุงู</span><span class="small">ููุนุงูู ููุฌูู ุนุงุฏูุ ูุง ุจุทุงูุฉ ุฎูุงูุฉ ุฐูุจูุฉ.</span></li>
        <li class="item"><span class="name">ุงูุชุนุงุฏู ูู ุงูุฅูุตุงุก</span><span class="small">ุฅุฐุง ุชุนุงุฏู ุงููุงุนุ ุฃูุบู ุงูุฅูุตุงุก ุฃู ุฃุฌุฑู ููุงุฌูุฉ ููุงููุฉ ูุตูุฑุฉ ููุฑุฑูุง ุงููุดุฑู.</span></li>
        <li class="item"><span class="name">ุจุทุงูุฉ ูุงุญุฏุฉ ููู ุฌููุฉ</span><span class="small">ุงูุงุณุชุฎุฏุงู ููุณุชููู ุงูุจุทุงูุฉ (ุญุตุงูุฉ/ูุฌูู ูุถุงุนู/ุชุงุฌุฑ/ูุดู).</span></li>
      </ul>
    </div>
  </section>

  <div class="footer">ุชุงุจุน ููููุน ุฃูุนุงุจ REDSWORD โ ูุตูู ูููุงุชูุ ุณูุณ ููุงูู ูููุดุฑู ููุท.</div>
</main>

<script>
(() => {
  // ุญุงูุฉ ุงููุนุจุฉ
  const state = {
    players: [], // {id,name,points,streakAttack,loyalAlliances,tradeCount,cards:[],history:{failedBetrayRounds:[]}, lastRoundPoints: null}
    round: 1,
    decisions: new Map(), // playerId -> {action,targetId,announcedAllianceWithId,usesCard:null|cardKey}
    autoCounter: 1,
    lastRoundPointsSnapshot: new Map(), // playerId -> points at end of round
    attacksThisRound: [], // {attackerId,targetId,success}
    // ุจุทุงูุงุช
    cardsCatalog: {
      shield: { key:'shield', name:'ุจุทุงูุฉ ุงูุญุตุงูุฉ', desc:'ููุน ูุฌูู ูุงุญุฏ ูู ูุฐู ุงูุฌููุฉ' },
      doubleAttack: { key:'doubleAttack', name:'ุจุทุงูุฉ ุงููุฌูู ุงููุถุงุนู', desc:'ูุฌูู ูุงุฌุญ ูููุญ 4 ููุงุท ุจุฏู 2' },
      doubleTrade: { key:'doubleTrade', name:'ุจุทุงูุฉ ุงูุชุงุฌุฑ', desc:'ุชุฌุงุฑุฉ ูุงุฌุญุฉ ุชููุญ ููุทุชูู' },
      reveal: { key:'reveal', name:'ุจุทุงูุฉ ุงููุดู', desc:'ูุดู ูุฑุงุฑ ูุงุนุจ ูุงุญุฏ ูุจู ุงูุฅุนูุงู (ูุฑุฌุนูุฉ ูููุดุฑู ููุท)' },
      goldenBetrayal: { key:'goldenBetrayal', name:'ุจุทุงูุฉ ุงูุฎูุงูุฉ ุงูุฐูุจูุฉ', desc:'ุชููุญ ุนูุฏ ุฎูุงูุฉ ููุนููุฉ ูุน ูุฌูู ูุงุฌุญ' }
    }
  };

  // ุนูุงุตุฑ DOM
  const tabs = document.querySelectorAll('.nav button');
  const sections = {
    players: document.getElementById('tab-players'),
    round: document.getElementById('tab-round'),
    points: document.getElementById('tab-points'),
    elimination: document.getElementById('tab-elimination'),
    help: document.getElementById('tab-help')
  };
  const playerNameInput = document.getElementById('playerName');
  const addPlayerBtn = document.getElementById('addPlayerBtn');
  const clearPlayersBtn = document.getElementById('clearPlayersBtn');
  const playersList = document.getElementById('playersList');
  const playersCountInfo = document.getElementById('playersCountInfo');
  const startGameBtn = document.getElementById('startGameBtn');

  const decisionsContainer = document.getElementById('decisionsContainer');
  const finalizeBtn = document.getElementById('finalizeBtn');
  const resetDecisionsBtn = document.getElementById('resetDecisionsBtn');
  const resultsText = document.getElementById('resultsText');
  const copyResultsBtn = document.getElementById('copyResultsBtn');
  const roundNumberEl = document.getElementById('roundNumber');
  const newRoundBtn = document.getElementById('newRoundBtn');

  const pointsTableBody = document.querySelector('#pointsTable tbody');

  const elimCriterionSel = document.getElementById('elimCriterion');
  const elimCandidateSel = document.getElementById('elimCandidate');
  const checkEliminationBtn = document.getElementById('checkEliminationBtn');
  const elimText = document.getElementById('elimText');
  const copyElimBtn = document.getElementById('copyElimBtn');

  // ุชุจุฏูู ุงูุชุจููุจุงุช
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      Object.keys(sections).forEach(k=>{
        sections[k].style.display = (k===tab?'block':'none');
      });
      if(tab==='points') renderPointsTable();
      if(tab==='round') { renderDecisionsForm(); roundNumberEl.textContent = state.round; }
      if(tab==='elimination') { renderEliminationOptions(); }
    });
  });

  // ุฅุถุงูุฉ ูุงุนุจ (ุงุณู ุชููุงุฆู ุฅู ูุงู ูุงุฑุบ)
  addPlayerBtn.addEventListener('click', ()=>{
    let name = playerNameInput.value.trim();
    if(!name){
      name = "ูุงุนุจ " + (state.autoCounter++);
    }
    const id = cryptoRandomId();
    state.players.push({
      id,name,points:0,streakAttack:0,loyalAlliances:0,tradeCount:0,cards:[],
      history:{failedBetrayRounds:[]}
    });
    playerNameInput.value='';
    renderPlayersList();
    renderEliminationOptions();
  });

  // ุชูููุถ ุชุนุฏูู/ุฅุฒุงูุฉ ุงููุงุนุจูู
  playersList.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const index = parseInt(btn.dataset.index,10);
    const action = btn.dataset.action;
    if(action==='edit'){
      const newName = prompt("ุฃุฏุฎู ุงูุงุณู ุงูุฌุฏูุฏ:", state.players[index].name);
      if(newName && newName.trim()){
        state.players[index].name = newName.trim();
        renderPlayersList();
        renderDecisionsForm();
        renderPointsTable();
        renderEliminationOptions();
      }
    } else if(action==='remove'){
      if(confirm("ูู ุชุฑูุฏ ุฅุฒุงูุฉ ูุฐุง ุงููุงุนุจุ")){
        const removed = state.players.splice(index,1)[0];
        state.decisions.delete(removed.id);
        // ุชูุธูู ุงููุฑุงุฑุงุช ุงููุฑุฌุนูุฉ
        state.decisions.forEach((d,pid)=>{
          if(d.targetId===removed.id) d.targetId = null;
          if(d.announcedAllianceWithId===removed.id) d.announcedAllianceWithId = null;
        });
        renderPlayersList();
        renderDecisionsForm();
        renderPointsTable();
        renderEliminationOptions();
      }
    }
  });

  // ูุณุญ ุฌููุน ุงููุงุนุจูู
  clearPlayersBtn.addEventListener('click', ()=>{
    if(!confirm('ูู ุชุฑูุฏ ูุณุญ ุฌููุน ุงููุงุนุจููุ')) return;
    state.players = [];
    state.decisions.clear();
    state.round = 1;
    state.lastRoundPointsSnapshot.clear();
    state.attacksThisRound = [];
    resultsText.value='';
    elimText.value='';
    roundNumberEl.textContent = state.round;
    renderPlayersList();
    decisionsContainer.innerHTML='';
    pointsTableBody.innerHTML='';
    renderEliminationOptions();
  });

  // ุจุฏุก ุงูุฌููุฉ ุงูุฃููู
  startGameBtn.addEventListener('click', ()=>{
    if(state.players.length < 2) return alert('ุฃุถู ูุงุนุจูู ููุงูุฉ (ุนูู ุงูุฃูู 2)');
    switchTab('round');
  });

  // ุฌููุฉ ุฌุฏูุฏุฉ
  newRoundBtn.addEventListener('click', ()=>{
    state.round += 1;
    state.decisions.clear();
    state.attacksThisRound = [];
    resultsText.value='';
    roundNumberEl.textContent = state.round;
    renderDecisionsForm();
  });

  // ูุณุฎ ุงููุชุงุฆุฌ
  copyResultsBtn.addEventListener('click', ()=>{
    resultsText.select();
    document.execCommand('copy');
    alert('ุชู ูุณุฎ ุงููุชุงุฆุฌ ููุต ุฌุงูุฒ.');
  });

  // ูุณุฎ ุงูุฅูุตุงุก
  copyElimBtn.addEventListener('click', ()=>{
    elimText.select();
    document.execCommand('copy');
    alert('ุชู ูุณุฎ ูุต ุงูุฅูุตุงุก.');
  });

  // ูุณุญ ุงููุฑุงุฑุงุช
  resetDecisionsBtn.addEventListener('click', ()=>{
    if(!confirm('ูุณุญ ุฌููุน ุงููุฑุงุฑุงุช ููุฐู ุงูุฌููุฉุ')) return;
    state.decisions.clear();
    decisionsContainer.querySelectorAll('.card').forEach(card=>{
      card.querySelector('select[data-field="action"]').value = '';
      card.querySelector('select[data-field="target"]').value = '';
      card.querySelector('select[data-field="announce"]').value = '';
      card.querySelector('select[data-field="useCard"]').value = '';
    });
    resultsText.value='';
  });

  // ุฅุนูุงู ุงููุชุงุฆุฌ: ูุญูุธ ุฌููุน ุงููุฑุงุฑุงุช ุชููุงุฆููุง ุซู ูุญุณุจ
  finalizeBtn.addEventListener('click', ()=>{
    if(state.players.length < 2) return alert('ุฃุถู ูุงุนุจูู ููุงูุฉ (ุนูู ุงูุฃูู 2)');
    // ุญูุธ ุชููุงุฆู ูููุฑุงุฑุงุช ูู ุงููุงุฌูุฉ
    decisionsContainer.querySelectorAll('.card').forEach(card=>{
      const pid = card.dataset.pid;
      const action = card.querySelector('select[data-field="action"]').value;
      const targetId = card.querySelector('select[data-field="target"]').value || null;
      const announceId = card.querySelector('select[data-field="announce"]').value || null;
      const useCard = card.querySelector('select[data-field="useCard"]').value || null;
      state.decisions.set(pid, {action,targetId,announcedAllianceWithId:announceId,usesCard:useCard});
    });

    // ุญุณุงุจ ุงููุชุงุฆุฌ
    const calc = computeResults();
    resultsText.value = calc.text;
    applyPoints(calc);
    awardCards(calc);
    renderPointsTable();
    // ููุทุฉ ููุงุท ูุฐู ุงูุฌููุฉ ูุฃุบุฑุงุถ "ุงูุฃูู ููุงุทูุง ูุฌููุชูู"
    state.lastRoundPointsSnapshot = new Map(state.players.map(p=>[p.id,p.points]));
    alert('ุชู ุญุณุงุจ ุงููุชุงุฆุฌ ูุชุญุฏูุซ ุงูููุงุท.');

    // ุชุญุถูุฑ ุตูุญุฉ ุงูุฅูุตุงุก
    renderEliminationOptions();
  });

  // ุงูุฅูุตุงุก: ุชุญูู/ุชูููุฐ
  checkEliminationBtn.addEventListener('click', ()=>{
    const message = performElimination();
    elimText.value = message || 'ูุง ููุฌุฏ ุฅูุตุงุก ููู ุงููุนุงููุฑ ุงูุญุงููุฉ.';
    if(message) {
      renderPlayersList();
      renderDecisionsForm();
      renderPointsTable();
      renderEliminationOptions();
      alert('ุชู ุชูููุฐ ุงูุฅูุตุงุก.');
    } else {
      alert('ูุง ุชูุทุจู ุดุฑูุท ุงูุฅูุตุงุก ุงูุขู.');
    }
  });

  // ูุธุงุฆู ูุณุงุนุฏุฉ ุนุงูุฉ
  function switchTab(tab){
    tabs.forEach(b=>{
      b.classList.toggle('active', b.dataset.tab===tab);
    });
    Object.keys(sections).forEach(k=>{
      sections[k].style.display = (k===tab?'block':'none');
    });
    if(tab==='round') { renderDecisionsForm(); roundNumberEl.textContent = state.round; }
    if(tab==='points') renderPointsTable();
    if(tab==='elimination') renderEliminationOptions();
  }
  function cryptoRandomId(){
    return 'p_' + Math.random().toString(36).slice(2,10);
  }

  // ุนุฑุถ ุงููุงุนุจูู
  function renderPlayersList(){
    playersList.innerHTML='';
    state.players.forEach((p,index)=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <span class="name">${p.name}</span>
        <span class="small muted">ุงูููุงุท: ${p.points} | ุจุทุงูุงุช: ${p.cards.map(c=>c.name).join('ุ ')||'ูุงููุฌุฏ'}</span>
        <div class="actions-cell">
          <button class="btn ghost" data-action="edit" data-index="${index}">โ๏ธ ุชุนุฏูู</button>
          <button class="btn warn" data-action="remove" data-index="${index}">๐๏ธ ุฅุฒุงูุฉ</button>
        </div>
      `;
      playersList.appendChild(div);
    });
    playersCountInfo.textContent = state.players.length ? `ุนุฏุฏ ุงููุงุนุจูู: ${state.players.length}` : '';
  }

  // ูุงุฌูุฉ ุงููุฑุงุฑุงุช
  function renderDecisionsForm(){
    decisionsContainer.innerHTML='';
    if(state.players.length===0){
      decisionsContainer.innerHTML='<div class="small muted">ุฃุถู ูุงุนุจูู ุฃููุงู.</div>';
      return;
    }
    state.players.forEach(p=>{
      const targets = state.players.filter(x=>x.id!==p.id);
      const cardOptions = p.cards.map(c=>`<option value="${c.key}">${c.name}</option>`).join('');
      const wrapper = document.createElement('div');
      wrapper.className='card';
      wrapper.dataset.pid = p.id;
      wrapper.innerHTML = `
        <div class="stack" style="justify-content:space-between; margin-bottom:.5rem">
          <div class="name">${p.name}</div>
          <div class="tag">ุงูููุงุท: ${p.points}</div>
        </div>
        <div class="row row-2">
          <div>
            <label>ุงูุฅุฌุฑุงุก</label>
            <select data-field="action">
              <option value="">โ ุงุฎุชุฑ โ</option>
              <option value="attack">ูุฌูู</option>
              <option value="alliance">ุชุญุงูู</option>
              <option value="trade">ุชุฌุงุฑุฉ</option>
              <option value="betray">ุฎูุงูุฉ (ูุงู ุฃุนูู ุชุญุงูููุง)</option>
              <option value="none">ูุง ุดูุก</option>
            </select>
          </div>
          <div>
            <label>ุงููุฏู/ุงูุดุฑูู</label>
            <select data-field="target">
              <option value="">โ ุงุฎุชุฑ โ</option>
              ${targets.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:.5rem">
          <div>
            <label>ุฅุนูุงู ุชุญุงูู ุนููู (ุงุฎุชูุงุฑูุ ููุชูุซูู)</label>
            <select data-field="announce">
              <option value="">โ ูุง ููุฌุฏ โ</option>
              ${targets.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
            </select>
            <div class="small muted">ุชููุฏ ูุชุฃููุฏ ุดุฑุนูุฉ ุงูุฎูุงูุฉ ุฅู ุญุฏุซุช.</div>
          </div>
        </div>
        <div class="row row-2" style="margin-top:.5rem">
          <div>
            <label>ุงุณุชุฎุฏุงู ุจุทุงูุฉ (ุงุฎุชูุงุฑู)</label>
            <select data-field="useCard">
              <option value="">โ ุจุฏูู ุจุทุงูุฉ โ</option>
              ${cardOptions || ''}
            </select>
            <div class="small muted">${p.cards.length? 'ูููู ุงุณุชุฎุฏุงู ุจุทุงูุฉ ูุงุญุฏุฉ ููุท ููู ุฌููุฉ.' : 'ูุง ุจุทุงูุงุช ูุชุงุญุฉ ุญุงููุงู ููุฐุง ุงููุงุนุจ.'}</div>
          </div>
        </div>
      `;
      // ููุก ุงูููู ุงููุญููุธุฉ ุณุงุจููุง
      const saved = state.decisions.get(p.id);
      if(saved){
        wrapper.querySelector('select[data-field="action"]').value = saved.action || '';
        wrapper.querySelector('select[data-field="target"]').value = saved.targetId || '';
        wrapper.querySelector('select[data-field="announce"]').value = saved.announcedAllianceWithId || '';
        wrapper.querySelector('select[data-field="useCard"]').value = saved.usesCard || '';
      }
      decisionsContainer.appendChild(wrapper);
    });
  }

  // ุงูุญุณุงุจ ุงูููุทูู ููุฌููุฉ
  function computeResults(){
    const playersById = Object.fromEntries(state.players.map(p=>[p.id,p]));
    const alliances = new Map();      // id -> partnerId (ุฅู ูุงู ูุชุจุงุฏููุง ูุตุจุญ ูุงุฌุญ)
    const trades = new Map();         // id -> partnerId (ุฅู ูุงูุช ูุชุจุงุฏูุฉ ุชุตุจุญ ูุงุฌุญุฉ)
    const attacks = [];               // {attackerId,targetId}
    const betrays = [];               // {betrayerId,targetId,validPublic}
    const shieldsUsed = new Set();    // playerId
    const doubleAttackUsed = new Set();
    const doubleTradeUsed = new Set();
    const textLines = [`ุงูุฌููุฉ ${state.round}:`];

    // ุชุฌููุน ุงููุฑุงุฑุงุช
    state.decisions.forEach((d, pid)=>{
      const p = playersById[pid];
      if(!p) return;
      const targetName = d.targetId ? playersById[d.targetId]?.name : '';
      // ุจุทุงูุงุช ูุณุชุฎุฏูุฉ
      if(d.usesCard){
        switch(d.usesCard){
          case 'shield': shieldsUsed.add(pid); break;
          case 'doubleAttack': doubleAttackUsed.add(pid); break;
          case 'doubleTrade': doubleTradeUsed.add(pid); break;
          case 'reveal': break;
          case 'goldenBetrayal': break;
        }
      }
      // ุงูุฅุฌุฑุงุกุงุช
      if(d.action==='alliance' && d.targetId){
        alliances.set(pid, d.targetId);
        textLines.push(`${p.name} ุฃุนูู ุชุญุงูููุง ูุน ${targetName}.`);
      } else if(d.action==='trade' && d.targetId){
        trades.set(pid, d.targetId);
        textLines.push(`${p.name} ุนูุฏ ุชุฌุงุฑุฉ ูุน ${targetName}.`);
      } else if(d.action==='attack' && d.targetId){
        attacks.push({attackerId:pid, targetId:d.targetId});
        textLines.push(`${p.name} ูุงุฌู ${targetName}.`);
      } else if(d.action==='betray' && d.targetId){
        const validPublic = (d.announcedAllianceWithId === d.targetId && !!d.announcedAllianceWithId);
        betrays.push({betrayerId:pid, targetId:d.targetId, validPublic});
        attacks.push({attackerId:pid, targetId:d.targetId});
        textLines.push(`${p.name} ุฎุงู ุงูุชุญุงูู ุงูููุนูู ุถุฏ ${targetName} ููุงุฌูู.`);
      } else if(d.action==='none'){
        textLines.push(`${p.name} ูู ูุชุฎุฐ ุฅุฌุฑุงุกู.`);
      }
    });

    // ุชุญุฏูุฏ ุงูุชุญุงููุงุช ุงููุงุฌุญุฉ (ูุชุจุงุฏูุฉ)
    const successfulAlliances = new Map();
    alliances.forEach((partner, id)=>{
      if(alliances.get(partner)===id){
        successfulAlliances.set(id, partner);
        successfulAlliances.set(partner, id);
      }
    });

    // ุชุญุฏูุฏ ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ (ูุชุจุงุฏูุฉ)
    const successfulTrades = new Map();
    trades.forEach((partner, id)=>{
      if(trades.get(partner)===id){
        successfulTrades.set(id, partner);
        successfulTrades.set(partner, id);
      }
    });

    // ูุชุงุฆุฌ ุงููุฌูุงุช
    const attackResults = []; // {attackerId,targetId,success,pointsAwarded,reason}
    attacks.forEach(atk=>{
      const targetAlliancePartner = successfulAlliances.get(atk.targetId);
      const targetShielded = shieldsUsed.has(atk.targetId);
      let success = true;
      let reason = '';
      if(targetShielded){
        success = false;
        reason = 'ุงููุฌูู ูุดู ุจุณุจุจ ุงูุญุตุงูุฉ';
      } else if(targetAlliancePartner){
        success = false;
        reason = 'ุงููุฌูู ูุดู ุจุณุจุจ ุชุญุงูู ูุงุฌุญ';
      }
      const points = success ? (doubleAttackUsed.has(atk.attackerId) ? 4 : 2) : 0;
      attackResults.push({attackerId:atk.attackerId,targetId:atk.targetId,success:success,pointsAwarded:points,reason});
    });

    // ูุต ุชูุตููู
    const detailedLines = [];
    // ุงูุชุญุงููุงุช ุงููุงุฌุญุฉ
    const printedAlliances = new Set();
    successfulAlliances.forEach((partner,id)=>{
      if(printedAlliances.has(id) || printedAlliances.has(partner)) return;
      detailedLines.push(`ุชุญุงูู ูุงุฌุญ ุจูู ${playersById[id].name} ู${playersById[partner].name} (1 ููุทุฉ ููู ููููุง).`);
      printedAlliances.add(id); printedAlliances.add(partner);
    });
    // ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ
    const printedTrades = new Set();
    successfulTrades.forEach((partner,id)=>{
      if(printedTrades.has(id) || printedTrades.has(partner)) return;
      const p1 = playersById[id], p2 = playersById[partner];
      const tradePoints1 = (doubleTradeUsed.has(id)?2:1);
      const tradePoints2 = (doubleTradeUsed.has(partner)?2:1);
      detailedLines.push(`ุชุฌุงุฑุฉ ูุงุฌุญุฉ ุจูู ${p1.name} ู${p2.name} (${tradePoints1} ููุทุฉ ูู ${p1.name}ุ ู${tradePoints2} ููุทุฉ ูู ${p2.name}).`);
      printedTrades.add(id); printedTrades.add(partner);
    });
    // ูุชูุฌุฉ ุงููุฌูุงุช
    attackResults.forEach(res=>{
      const attacker = playersById[res.attackerId].name;
      const target = playersById[res.targetId].name;
      if(res.success){
        detailedLines.push(`ูุฌูู ูุงุฌุญ: ${attacker} ุนูู ${target} (+${res.pointsAwarded} ููุงุท).`);
      } else {
        detailedLines.push(`ูุฌูู ูุงุดู: ${attacker} ุนูู ${target} (${res.reason}).`);
      }
    });

    // ุญูุธ ูุชูููู ุงูุฅูุตุงุก ุงูุชููุงุฆู (ูุฌููุงู ุนูู ููุณ ุงููุฏู)
    state.attacksThisRound = attackResults.map(r=>({attackerId:r.attackerId,targetId:r.targetId,success:r.success}));

    // ููุญ ุงูุฎูุงูุฉ ุงูุฐูุจูุฉ
    const goldenWinners = [];
    betrays.forEach(b=>{
      if(!b.validPublic) return;
      const found = attackResults.find(r=>r.attackerId===b.betrayerId && r.targetId===b.targetId && r.success);
      if(found) goldenWinners.push(b.betrayerId);
      else {
        // ุณุฌูู ุฎูุงูุฉ ูุงุดูุฉ ููุฐู ุงูุฌููุฉ
        const player = playersById[b.betrayerId];
        player.history.failedBetrayRounds.push(state.round);
        // ุงุญุชูุงุธ ููุท ุจุขุฎุฑ 3 ุฌููุงุช
        if(player.history.failedBetrayRounds.length>3){
          player.history.failedBetrayRounds = player.history.failedBetrayRounds.slice(-3);
        }
      }
    });
    goldenWinners.forEach(id=>{
      detailedLines.push(`ุจุทุงูุฉ ุงูุฎูุงูุฉ ุงูุฐูุจูุฉ: ${playersById[id].name} ุญุตู ุนูููุง ูุฎูุงูุฉ ููุนููุฉ ูุน ูุฌูู ูุงุฌุญ.`);
    });

    const text = [...textLines, '', ...detailedLines].join('\n');
    return {
      text,
      successfulAlliances,
      successfulTrades,
      attackResults,
      shieldsUsed,
      doubleAttackUsed,
      doubleTradeUsed,
      goldenWinners
    };
  }

  // ุชุทุจูู ุงูููุงุท
  function applyPoints(calc){
    const byId = Object.fromEntries(state.players.map(p=>[p.id,p]));
    const didAttackSuccess = new Map(); // id -> bool
    state.players.forEach(p=>didAttackSuccess.set(p.id,false));

    // ุงูุชุญุงููุงุช ุงููุงุฌุญุฉ
    const countedAlliances = new Set();
    calc.successfulAlliances.forEach((partner,id)=>{
      if(countedAlliances.has(id) || countedAlliances.has(partner)) return;
      byId[id].points += 1;
      byId[partner].points += 1;
      byId[id].loyalAlliances += 1;
      byId[partner].loyalAlliances += 1;
      countedAlliances.add(id); countedAlliances.add(partner);
    });

    // ุงูุชุฌุงุฑุฉ ุงููุงุฌุญุฉ
    const countedTrades = new Set();
    calc.successfulTrades.forEach((partner,id)=>{
      if(countedTrades.has(id) || countedTrades.has(partner)) return;
      const pts1 = calc.doubleTradeUsed.has(id) ? 2 : 1;
      const pts2 = calc.doubleTradeUsed.has(partner) ? 2 : 1;
      byId[id].points += pts1; byId[partner].points += pts2;
      byId[id].tradeCount += 1; byId[partner].tradeCount += 1;
      countedTrades.add(id); countedTrades.add(partner);
    });

    // ุงููุฌูุงุช
    calc.attackResults.forEach(r=>{
      if(r.success){
        byId[r.attackerId].points += r.pointsAwarded;
        didAttackSuccess.set(r.attackerId,true);
      }
    });

    // ุชุญุฏูุซ ุณูุงุณู ุงููุฌูู
    state.players.forEach(p=>{
      if(didAttackSuccess.get(p.id)) p.streakAttack += 1;
      else p.streakAttack = 0;
    });

    // ุงุณุชููุงู ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ
    state.decisions.forEach((d, pid)=>{
      if(!d.usesCard) return;
      const p = byId[pid];
      const idx = p.cards.findIndex(c=>c.key===d.usesCard);
      if(idx>=0 && ['shield','doubleAttack','doubleTrade','reveal'].includes(d.usesCard)){
        p.cards.splice(idx,1);
      }
    });

    // ุฅุถุงูุฉ ุงูุฎูุงูุฉ ุงูุฐูุจูุฉ ุงูููุชุณุจุฉ
    calc.goldenWinners.forEach(pid=>{
      const p = byId[pid];
      const has = p.cards.some(c=>c.key==='goldenBetrayal');
      if(!has) p.cards.push(state.cardsCatalog.goldenBetrayal);
    });
  }

  // ููุญ ุงูุจุทุงูุงุช ุจุงูุฅูุฌุงุฒ
  function awardCards(calc){
    state.players.forEach(p=>{
      if(p.streakAttack>=2 && !p.cards.some(c=>c.key==='doubleAttack')){
        p.cards.push(state.cardsCatalog.doubleAttack);
      }
      if(p.loyalAlliances>=2 && !p.cards.some(c=>c.key==='shield')){
        p.cards.push(state.cardsCatalog.shield);
      }
      if(p.tradeCount>=3 && !p.cards.some(c=>c.key==='doubleTrade')){
        p.cards.push(state.cardsCatalog.doubleTrade);
      }
    });
  }

  // ุฌุฏูู ุงูููุงุท ูุงูุจุทุงูุงุช
  function renderPointsTable(){
    pointsTableBody.innerHTML='';
    state.players.forEach(p=>{
      const tr = document.createElement('tr');
      const cardsText = p.cards.map(c=>c.name).join('ุ ') || 'โ';
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.points}</td>
        <td>${p.streakAttack}</td>
        <td>${p.loyalAlliances}</td>
        <td>${p.tradeCount}</td>
        <td>${cardsText}</td>
        <td>
          <select data-card>
            <option value="">โ ุงุฎุชุฑ ุจุทุงูุฉ โ</option>
            ${p.cards.map(c=>`<option value="${c.key}">${c.name}</option>`).join('')}
          </select>
          <button class="btn warn" data-use>ุชูุนูู</button>
        </td>
      `;
      const sel = tr.querySelector('select[data-card]');
      const btn = tr.querySelector('button[data-use]');
      btn.addEventListener('click', ()=>{
        const key = sel.value;
        if(!key) return alert('ุงุฎุชุฑ ุจุทุงูุฉ ูุงุณุชุฎุฏุงููุง.');
        const existing = state.decisions.get(p.id) || {action:'none',targetId:null,announcedAllianceWithId:null,usesCard:null};
        existing.usesCard = key;
        state.decisions.set(p.id, existing);
        alert('ุชู ุชุนููู ุงุณุชุฎุฏุงู ุงูุจุทุงูุฉ ููุฐู ุงูุฌููุฉ. ุณูุชู ุชุทุจูููุง ุนูุฏ ุฅุนูุงู ุงููุชุงุฆุฌ.');
        renderDecisionsForm();
      });
      pointsTableBody.appendChild(tr);
    });
  }

  // ุงูุฅูุตุงุก: ูุงุฌูุฉ ุงููุฑุดุญูู
  function renderEliminationOptions(){
    // ููุก ูุงุฆูุฉ ุงููุฑุดุญูู
    elimCandidateSel.innerHTML = `<option value="">โ ุงุฎุชุฑ ูุงุนุจูุง (ูููุนุงููุฑ ุงููุฏููุฉ) โ</option>`;
    state.players.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      elimCandidateSel.appendChild(opt);
    });
  }

  // ุชูููุฐ ุงูุฅูุตุงุก ููู ุงููุนุงููุฑ
  function performElimination(){
    const criterion = elimCriterionSel.value;

    // ุจูุงุก ุฎุฑูุทุฉ id->player
    const byId = Object.fromEntries(state.players.map(p=>[p.id,p]));

    // 1) ุชููุงุฆู: ูุฌููุงู ูุงุฌุญุงู ูู ููุณ ุงูุฌููุฉ ุถุฏ ููุณ ุงููุงุนุจ
    if(criterion==='auto'){
      const successAttacks = state.attacksThisRound.filter(a=>a.success);
      const targetsCount = {};
      successAttacks.forEach(a=>{
        targetsCount[a.targetId] = (targetsCount[a.targetId]||0)+1;
      });
      const doomed = Object.entries(targetsCount).find(([tid,count])=>count>=2);
      if(doomed){
        const targetId = doomed[0];
        const name = byId[targetId]?.name || 'ูุงุนุจ';
        removePlayerById(targetId);
        return `ุชู ุฅูุตุงุก ${name} ูุชุนุฑุถู ููุฌูููู ูุงุฌุญูู ูู ููุณ ุงูุฌููุฉ.`;
      }
      return '';
    }

    // 2) ุงูุฃูู ููุงุทูุง ูุฌููุชูู ูุชุชุงููุชูู
    if(criterion==='lowestTwoRounds'){
      if(state.lastRoundPointsSnapshot.size===0){
        return 'ูุง ูููู ุชุทุจูู ูุฐุง ุงููุนูุงุฑ ุงูุขู: ูุง ุชูุฌุฏ ุจูุงูุงุช ุงูุฌููุฉ ุงูุณุงุจูุฉ.';
      }
      // ุงุจุญุซ ุนู ุฃูู ููุงุท ูู ุงูุฌููุฉ ุงูุณุงุจูุฉ ูุงูุญุงููุฉ
      const prevMin = Math.min(...Array.from(state.lastRoundPointsSnapshot.values()));
      const prevIds = Array.from(state.lastRoundPointsSnapshot.entries()).filter(([id,pts])=>pts===prevMin).map(([id])=>id);
      const currentMin = Math.min(...state.players.map(p=>p.points));
      const currentIds = state.players.filter(p=>p.points===currentMin).map(p=>p.id);
      // ุชูุงุทุน
      const intersection = prevIds.filter(id=>currentIds.includes(id));
      if(intersection.length===1){
        const targetId = intersection[0];
        const name = byId[targetId]?.name || 'ูุงุนุจ';
        removePlayerById(targetId);
        return `ุชู ุฅูุตุงุก ${name} ูููู ุงูุฃูู ููุงุทูุง ูู ุฌููุชูู ูุชุชุงููุชูู.`;
      } else if(intersection.length>1){
        return 'ุชุนุงุฏู ุงููุงุนุจูู ุงูุฃูู ููุงุทูุง ูู ุฌููุชููุ ูููุบู ุงูุฅูุตุงุก ุฃู ุงุญุณูู ุจููุงุฌูุฉ ููุงููุฉ ูุตูุฑุฉ.';
      } else {
        return 'ูุง ุฃุญุฏ ูุงู ุงูุฃูู ููุงุทูุง ูู ุฌููุชูู ูุชุชุงููุชููุ ูุง ุฅูุตุงุก ุจูุฐุง ุงููุนูุงุฑ.';
      }
    }

    // 3) ุฎูุงูุฉ ููุนููุฉ ูุงุดูุฉ ูุฑุชูู ุฎูุงู ุซูุงุซ ุฌููุงุช
    if(criterion==='failedBetrayTwice'){
      let candidate = elimCandidateSel.value || '';
      if(!candidate){
        // ุจุญุซ ุชููุงุฆู ุนู ูุงุนุจ ูุณุชููู ุงูุดุฑุท
        const found = state.players.find(p=>{
          const arr = p.history.failedBetrayRounds || [];
          // ุฎูุงู ุขุฎุฑ ุซูุงุซ ุฌููุงุชุ ูู ููุฌุฏ ุฌููุชุงู ูุดูุ
          return arr.length>=2;
        });
        candidate = found?.id || '';
      }
      if(!candidate) return 'ูุง ููุฌุฏ ูุงุนุจ ูุณุชููู ุดุฑุท ุฎูุงูุชูู ูุงุดูุชูู ุฎูุงู ุซูุงุซ ุฌููุงุช.';
      const player = byId[candidate];
      const arr = player.history.failedBetrayRounds || [];
      if(arr.length>=2){
        const name = player.name;
        removePlayerById(player.id);
        return `ุชู ุฅูุตุงุก ${name} ุจุนุฏ ุฎูุงูุชูู ููุนููุชูู ูุงุดูุชูู ุฎูุงู ุซูุงุซ ุฌููุงุช.`;
      } else {
        return 'ุงููุงุนุจ ุงููุญุฏุฏ ูุง ูุณุชููู ุดุฑุท ุฎูุงูุชูู ูุงุดูุชูู.';
      }
    }

    // 4) ุชุตููุช ูุญุฏูุฏ (ูุฏูู): ูุนุชูุฏ ุนูู ุงุฎุชูุงุฑ ูุฑุดุญ
    if(criterion==='manualVote'){
      const targetId = elimCandidateSel.value;
      if(!targetId) return 'ุงุฎุชุฑ ูุงุนุจูุง ููุฑุดุญ ููุฅูุตุงุก ุซู ูููุฐ ุงููุฑุงุฑ ููู ุงูุชุตููุช ูู ุงูุบุฑูุฉ.';
      const name = byId[targetId]?.name || 'ูุงุนุจ';
      // ูุง ูุญุฐูู ูุจุงุดุฑุฉู ุฅูุง ุฅุฐุง ุฃุฑุฏุช ุชูููุฐ ุงูุชุตููุช ูุฏูููุง
      const confirmVote = confirm(`ูู ุชุฃูุฏ ุงูุชุตููุช ูุฅูุตุงุก ${name}ุ`);
      if(confirmVote){
        removePlayerById(targetId);
        return `ุชู ุฅูุตุงุก ${name} ุนุจุฑ ุชุตููุช ูุญุฏูุฏ ุจุนุฏ ุชุนููู ูููุน.`;
      } else {
        return 'ุชู ุฅูุบุงุก ุงูุฅูุตุงุก ุงููุฏูู.';
      }
    }

    return '';
  }

  // ุฅุฒุงูุฉ ูุงุนุจ ุนุจุฑ id
  function removePlayerById(id){
    const idx = state.players.findIndex(p=>p.id===id);
    if(idx>=0){
      const removed = state.players.splice(idx,1)[0];
      // ุชูุธูู ุงููุฑุงุฑุงุช
      state.decisions.delete(removed.id);
      state.decisions.forEach((d,pid)=>{
        if(d.targetId===removed.id) d.targetId = null;
        if(d.announcedAllianceWithId===removed.id) d.announcedAllianceWithId = null;
      });
      // ูููู ููุง ุชุทุจูู ููุทู "ุจูู ุงููุดุฑู" ูุณุญุจ ุจุทุงูุฉ ุนุดูุงุฆูุฉ ูู ุงููููุตู ูุฅุชุงุญุชูุง ูุงุญููุง
      // (ุงุฎุชูุงุฑู: ุญุณุจ ุชูุถููู)
    }
  }

  // ุนุฑุถ ููุงุท/ุจุทุงูุงุช/ุชูุนูู
  // (ุชู ุฃุนูุงู)

  // ุจุฏุงูุฉ
  renderPlayersList();

})();
</script>
</body>
</html>
